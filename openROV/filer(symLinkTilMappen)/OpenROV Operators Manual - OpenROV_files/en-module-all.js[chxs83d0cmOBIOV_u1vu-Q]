/*
			BSD-style license
 @author			nwhite - < nw [at] nwhite.net >
 @infos			http://www.nwhite.net/MooCrop/
 @copyright		Author

 @modifiedby    Dave, July 2008
*/
MooCrop=new Class({Implements:[Options,Events],calculateHandles:!0,current:{},options:{maskColor:"black",maskOpacity:".4",handleColor:"#999",handleBorder:"1px solid #333",handleWidth:"6px",handleHeight:"6px",cropBorder:"1px dashed #aaa",min:{width:60,height:45},start:{top:0,left:0,width:592,height:444},showMask:!0,showHandles:!1,ratio:"FOUR_THREE",container:{width:800,height:600}},initialize:function(b,a){"ONE_ONE"==a.ratio?a.start.width=a.start.height:a.adjustRatio&&(a.start.top=a.start.left=0,a.start.height=
a.min.height,a.start.width=a.min.width);switch(a.ratio){case "FOUR_THREE":a.ratio=.75;break;case "ONE_ONE":a.ratio=1;break;default:a.ratio=!1}this.setOptions(a);a=this.options;var c=this.img=$(b);a.min.width=Math.min(c.width,a.min.width);a.min.height=Math.min(c.height,a.min.height);this.resizeFunc=this.refresh.bind(this);this.removeFunc=this.removeListener.bind(this);this.buildOverlay();this.setup()},setup:function(){$(this.cropArea).setStyles({width:this.options.start.width,height:this.options.start.height,
top:this.options.start.top,left:this.options.start.left});this.current.crop=this.crop=this.getCropArea();this.handleWidthOffset=this.options.handleWidth.toInt()/2;this.handleHeightOffset=this.options.handleHeight.toInt()/2;this.fixBoxModel();this.drawMasks();this.positionHandles()},getCropArea:function(){var b=this.cropArea.getCoordinates();b.left-=this.offsets.x;b.right-=this.offsets.x;b.top-=this.offsets.y;b.bottom-=this.offsets.y;return b},fixBoxModel:function(){var b=this.boxDiff=(this.crop.width-
this.options.start.width)/2,a=this.bounds={top:b,left:b,right:this.img.width+2*b,bottom:this.img.height+2*b,width:this.options.min.width+2*b,height:this.options.min.height+2*b};this.wrapper.setStyles({width:a.right,height:a.bottom});this.img.setStyles({top:b,left:b});this.north.setStyle("width",a.right);this.south.setStyle("width",a.right)},activate:function(b,a){a.stop();this.current={x:a.page.x,y:a.page.y,handle:b,crop:this.current.crop};"NESW"!=this.current.handle||this.options.showHandles||this.hideHandles();
this.fireEvent("onBegin",[this.img.src,this.getCropInfo(),this.bounds,b]);document.addListener("mousemove",this.resizeFunc);document.addListener("mouseup",this.removeFunc)},removeListener:function(){"NESW"!=this.current.handle||this.options.showHandles||this.showHandles();document.removeListener("mousemove",this.resizeFunc);document.removeListener("mouseup",this.removeFunc);this.crop=this.current.crop;this.fireEvent("onComplete",[this.img.src,this.getCropInfo(),this.bounds,this.current.handle])},
refresh:function(b){var a=0,c=this.current.x-b.pageX,d=this.current.y-b.pageY;b=this.bounds;var e=this.crop,g=this.current.handle,f={},h=2<g.length?!0:!1;g.contains("S")&&e.bottom-d>b.bottom&&(d=e.bottom-b.bottom);g.contains("N")&&e.top-d<b.top&&(d=e.top);g.contains("E")&&e.right-c>b.right&&(c=e.right-b.right);g.contains("W")&&e.left-c<b.left&&(c=e.left);if(this.options.ratio&&!h)if(Math.abs(c)>Math.abs(d)*this.options.ratio){var m=d="SE"==g||"NW"==g?Math.round(c*this.options.ratio):-Math.round(c*
this.options.ratio);g.contains("S")&&e.bottom-d>b.bottom&&(d=e.bottom-b.bottom,a="SE"==g||"NW"==g?-1:1);g.contains("N")&&e.top-d<b.top&&(d=e.top,a="SE"==g||"NW"==g?-1:1);a&&(c+=a*Math.round((m-d)/this.options.ratio))}else c="SE"==g||"NW"==g?Math.round(d/this.options.ratio):-Math.round(d/this.options.ratio),a=0,m=c,g.contains("E")&&e.right-c>b.right&&(c=e.right-b.right,a="SE"==g||"NW"==g?-1:1),g.contains("W")&&e.left-c<b.left&&(c=e.left,a="SE"==g||"NW"==g?-1:1),a&&(d+=a*Math.round((m-c)*this.options.ratio));
g.contains("S")&&!h&&(e.height-d<b.height&&(d=e.height-b.height),f.height=e.height-d);g.contains("N")&&(h||(e.height+d<b.height&&(d=b.height-e.height),f.height=e.height+d),f.top=e.top-d);g.contains("E")&&!h&&(e.width-c<b.width&&(c=e.width-b.width),f.width=e.width-c);g.contains("W")&&(h||(e.width+c<b.width&&(c=b.width-e.width),f.width=e.width+c),f.left=e.left-c);a=Object.clone(f);null!=f.width&&(f.width-=2*this.boxDiff);null!=f.height&&(f.height-=2*this.boxDiff);this.cropArea.setStyles(f);this.getCurrentCoords(a);
this.drawMasks();this.positionHandles();this.fireEvent("onCrop",[this.img.src,this.getCropInfo(),b,g])},getCurrentCoords:function(b){var a=Object.clone(this.crop);null!=b.left&&(a.left=b.left,null!=b.width?a.width=b.width:a.right=a.left+a.width);null!=b.top&&(a.top=b.top,null!=b.height?a.height=b.height:a.bottom=a.top+a.height);null!=b.width&&null==b.left&&(a.width=b.width,a.right=a.left+a.width);null!=b.height&&null==b.top&&(a.height=b.height,a.bottom=a.top+a.height);this.current.crop=a},drawMasks:function(){if(this.options.showMask){var b=
this.bounds,a=this.current.crop;this.north.setStyle("height",a.top);this.south.setStyle("height",b.bottom-a.bottom);this.east.setStyles({height:a.height,width:b.right-a.right,top:a.top,left:a.right});this.west.setStyles({height:a.height,width:a.left,top:a.top})}},positionHandles:function(){if(this.calculateHandles){var b=this.current.crop,a=this.handleWidthOffset+this.bounds.left,c=this.handleHeightOffset+this.bounds.top;this.options.ratio||(this.handles.get("N").setStyles({left:b.width/2-a,top:-c}),
this.handles.get("E").setStyles({left:b.width-a,top:b.height/2-c}),this.handles.get("S").setStyles({left:b.width/2-a,top:b.height-c}),this.handles.get("W").setStyles({left:-a,top:b.height/2-c}));this.handles.get("NE").setStyles({left:b.width-a,top:-c});this.handles.get("SE").setStyles({left:b.width-a,top:b.height-c});this.handles.get("SW").setStyles({left:-a,top:b.height-c});this.handles.get("NW").setStyles({left:-a,top:-c})}},hideHandles:function(){this.calculateHandles=!1;this.handles.each(function(b){b.setStyle("display",
"none")})},showHandles:function(){this.calculateHandles=!0;this.positionHandles();this.handles.each(function(b){b.setStyle("display","block")})},buildOverlay:function(){var b=this.options;this.wrapper=(new Element("div",{styles:{position:"relative",width:this.img.width,height:this.img.height,"float":this.img.getStyle("float"),"margin-left":Math.round((b.container.width-this.img.width)/2)}})).inject(this.img,"before");this.wrapper.grab(this.img);this.img.setStyle("position","absolute");this.offsets=
{x:this.wrapper.getLeft(),y:this.wrapper.getTop()};if(this.options.showMask){var a={left:0,position:"absolute",overflow:"hidden","background-color":b.maskColor,opacity:b.maskOpacity};this.north=(new Element("div",{styles:a})).inject(this.wrapper,"inside");this.south=(new Element("div",{styles:Object.merge(a,{bottom:0})})).inject(this.wrapper,"inside");this.east=(new Element("div",{styles:a})).inject(this.wrapper,"inside");this.west=(new Element("div",{styles:a})).inject(this.wrapper,"inside")}this.cropArea=
(new Element("div",{styles:{position:"absolute",top:0,left:0,border:b.cropBorder,cursor:"move"},events:{dblclick:function(){this.fireEvent("onDblClk",[this.img.src,this.getCropInfo(),this.bounds])}.bind(this),mousedown:this.activate.bind(this,"NESW")}})).inject(this.wrapper,"inside");this.handles=new Hash;(this.options.ratio?["NE","SE","SW","NW"]:"N NE E SE S SW W NW".split(" ")).each(function(a){this.handles.set(a,(new Element("div",{styles:{position:"absolute","margin-left":-1,"margin-top":-1,"background-color":b.handleColor,
border:b.handleBorder,width:b.handleWidth,height:b.handleHeight,overflow:"hidden",cursor:a.toLowerCase()+"-resize"},events:{mousedown:this.activate.bind(this,a)}})).addClass("cropHandle").inject(this.cropArea,"inside"))},this)},getCropInfo:function(){var b=Object.clone(this.current.crop);b.width-=2*this.boxDiff;b.height-=2*this.boxDiff;return b},removeOverlay:function(){this.wrapper.destroy();this.img.setStyle("display","block")},setImage:function(b){this.img.src=b;this.wrapper.setStyle("background",
"url("+this.img.src+") no-repeat "+this.boxDiff+"px "+this.boxDiff+"px")}});
FrameModules.add("ImageCropFrameModule",function(){Modal.addEvents({onImageCropLoad:function(a,b,e){ImageCrop.initialize(a,b,e)},onImageCropDisplay:function(a){ImageCrop.display(a)},onImageCropUnload:function(){ImageCrop._unload()}});window.ImageCrop={thumb:{width:592,height:444},options:{min:{width:50,height:50}},dimensions:{},events:null,showForMediaItem:function(a,b,e){b=b&&b.getMediaFilterName();"guide_step_video"==b&&(b="guide_step_image");Modal.open({type:"module",name:"ImageCrop",boxClass:"mediaLibraryModalBox cropContainer",
serverOptions:{imageid:a.getID(),accepts:b},clientOptions:{mediaItem:a,mediaItemFilterName:b,events:{complete:function(a){e&&e(a)}}}})},initialize:function(c,d,e){this.events=new Events;this.events.addEvents(d.events);this.mediaImage=d.mediaItem;this.sourceImageData=new MediaItemData(e.sourceImage);this.suggestedCrop=e.suggestedCrop;this.imageData=new MediaItemData(e.image);this.mediaImage.setData(this.imageData);c=this.filter=new b(e.filterInfo);c.width()&&(this.options.min={width:c.width(),height:c.height()});
this.clientOptions=d||{};this.container=$("imageCropContainer");new a(this.events,$(document));this.addClickEvents();this.attachImage(this.sourceImageData)},display:function(){this.cropper||this.createCropper(this.sourceImageData)},addClickEvents:function(){$("imageCropButton").removeEvents().addEvent("click",function(){this.save()}.bind(this));clickSafe($("cropCloseBtn"),function(){Modal.cancel()})},attachImage:function(a){var b=this.mediaImage.getUncroppedPreview("medium");img=new Element("img",
{src:b,"class":"img"});img.set({id:"cropImage"}).setStyles({width:a.scaled_width(),height:a.scaled_height()});this.container.empty().adopt(img);this.updateDimensions({original_width:a.width(),original_height:a.height()});this.container.setStyles({height:a.scaled_height()})},createCropper:function(a){function b(d){var f=Math.round(q*d.top),g=Math.round(q*d.left),h=Math.round(q*d.width);d=Math.round(q*d.height);"FOUR_THREE"==p&&(h-=h%4,d=.75*h,h<e.options.min.width||d<e.options.min.height)&&(h=e.options.min.width,
d=e.options.min.height);"ONE_ONE"==p&&(d=h=Math.min(h,d));h>a.width()&&(g=0,h=a.width());d>a.height()&&(f=0,d=a.height());e.updateDimensions({top:f,left:g,width:h,height:d})}var e=this,g=this.imageData,f=a.scaled_width(),h=a.scaled_height(),m,n,l;(l=(g=this.suggestedCrop||g.markup())?g.crop:null)?(g=l.size.width,m=l.size.height,n=l.from.y,l=l.from.x):(g=a.width(),m=a.height(),l=n=0);this.updateDimensions({top:n,left:l,width:g,height:m});var q=a.width()/f,p=this.filter.ratio();this.cropper=(new MooCrop("cropImage",
{container:this.thumb,start:{width:Math.round(g/a.width()*f),height:Math.round(m/a.height()*h),top:Math.round(n/a.height()*h),left:Math.round(l/a.width()*f)},min:{width:Math.ceil(this.options.min.width/a.width()*f),height:Math.ceil(this.options.min.height/a.height()*h)},ratio:p,adjustRatio:"FOUR_THREE"==p&&.05<Math.abs(.75-m/g)})).addEvent("onCrop",function(a,c){b(c)});b(this.cropper.getCropInfo())},updateDimensions:function(a){Object.append(this.dimensions,a);this.events.fireEvent("changeDimensions",
[this.dimensions])},getMarkupString:function(){var a=this.getMarkup(),a=";"+("crop,"+a.crop.from.x+"x"+a.crop.from.y+","+a.crop.size.width+"x"+a.crop.size.height+";"+(a.enhance?"enhance;":""));return a+this.mediaImage.markersString()},getMarkup:function(){var a=this.dimensions,b={};b.crop={from:{x:a.left,y:a.top},size:{width:a.width,height:a.height}};return b},save:function(){function a(c){c.error?b(c.error):h.resolve(c)}function b(a){h.error(a)}var e=this,g=this.mediaImage,f=this.getMarkupString(),
h=new Future;Modal.lock().loading(_js("Saving your changes..."));(new Request.AjaxIO("cropImage",{onSuccess:function(f){g.setDataPromise(h);e._finished(e.mediaItem);(new Request.AjaxIO("cropImageStatus",{timeout:6E4,onComplete:a,onTimeout:b})).ping(f,!0,e.clientOptions.mediaItemFilterName);Modal.doneLoading().unlock().pop()}.bind(this)})).send(g.getID(),f,this.filter.ratio())},_unload:function(){this.cropper&&(this.cropper.removeEvents(),this.cropper=null);this._finished()},_finished:function(a){this.events&&
(this.events.fireEvent("complete",a?[a]:null),delete this.events)}};Object.append(ImageCrop,Utils.EventsFunctions);var b=StrictObject.define(["ratio","width","height"]),a=new Class({initialize:function(a,b){var e={top:b.getElement(".image_top"),left:b.getElement(".image_left"),width:b.getElement(".image_width"),height:b.getElement(".image_height"),original_width:b.getElement(".original_width"),original_height:b.getElement(".original_height")};a.addEvent("changeDimensions",function(a){Object.each(a,
function(a,b){e[b].set("html",a)})})}})});
MediaLibrary={loadOptions:{accepts:"all"},imageExtensions:{jpeg:"i",jpg:"i",gif:"i",png:"i",bmp:"i",tiff:"i",tif:"i"},documentExtensions:{pdf:"d"},videoExtensions:{mov:"v",avi:"v",mp4:"v",mpeg:"v",wmv:"v",ogg:"v",flv:"v"},_loaded:!1,events:null,container:null,itemFilter:"all",initialize:function(){this.allExtensions=Object.merge(Object.clone(this.imageExtensions),this.documentExtensions,this.videoExtensions);Modal.addEvents({onMediaLibraryLoad:function(b,a,c){this.mediaItems=[];this.thumbnails=[];
this._loaded=!0;this.events=new Events;this.events.addEvents(a.events);this.container=b.getElement("#mediaLibrary");this._deleteAll=$("deleteAllMedia");this.loadOptions=Object.append(this.loadOptions,a);this.mediaFilterName=(this.mediaTarget=a.target)?this.mediaTarget.getMediaFilterName():null;clickSafe($("libraryCloseBtn"),function(){Modal.cancel()});this._initNavigation();this.uploadUrl=$("mediaUploadFallback").action;this.mediaUploadArea=$("mediaUpload");this.createUploader();this.browseWindow=
$("mediaBrowse");this.alertsContainer=this.container.getElement(".statuses");this._setupDeleteAll();this.setupSorting();this._loadItems(c)}.bind(this),onMediaLibraryUnload:function(){this._loaded=!1;delete this.events}.bind(this)})},_loadItems:function(b){var a=this,c=a.loadOptions.attachedItems,d=b.items;a.itemFilter=b.itemFilter;a._initFilters();a.events.fireEvent("itemCountChanged");d.reverse().each(function(b){b=MediaItem.createFromData(b);var d=c[b.getGlobalID()];a.addItem(b,d)});$("addMedia").addEvents({"click:relay(.js-url-embed-submit)":function(b,
c){var d=Object.keys(MediaLibrary.imageExtensions),d=new RegExp(d.join("|")),h=$E(".js-url-embed-link").value,m=h.match(d),d={url:h};(new Request.API_2_0(m?"user/media/images/url":"user/media/embed",{method:"post",onSuccess:function(b){var c=new Future,d=MediaItem.createFromData(b,{},c),f=m?b.guid:b.objectid;(new Request.AjaxIO("isMediaItemReady",{onComplete:function(a){a.error?c.error(a.error):c.resolve(a)}})).ping(f,b.type,a.mediaFilterName);a.addItem(d,!1)},onFailure:function(a,b){MediaLibrary.appendAlertMessage(b,
"error")}})).send(d);a._toggleView()}});$("mediaLibrary").addEvents({"click:relay(.js-toggle-selected)":function(a,b){var c=b.hasClass("selected");$$(".js-toggle-target").removeClass("toggle-open");$$(".js-toggle-selected").removeClass("selected");var d=b.getParent().getElement(".js-toggle-target");c?(d.removeClass("toggle-open"),b.removeClass("selected")):(d.addClass("toggle-open"),b.addClass("selected"))},"click:relay(.js-toggle-target)":function(a,b){$$(".js-toggle-target").removeClass("toggle-open");
$$(".js-toggle-selected").removeClass("selected");var c=$E(".sortOption.active").get("text");$E(".js-current-sort-name").set("text",c)}})},showForTarget:function(b,a,c){var d=b.getMediaFilterName()||this.loadOptions.accepts;b=Modal.open.pass([{type:"module",name:"MediaLibrary",boxClass:"mediaLibraryModalBox",clientOptions:{target:b,attachedItems:c,events:{itemSelected:a}},serverOptions:{accepts:d},onCancel:a}],Modal);Auth.isLoggedIn()?b():Auth.required({onAuthorize:b,onCancel:a})},dismissAlerts:function(){this.alertsContainer.getChildren().each(function(b){b=
b.getChildren(".close-status").pick();"undefined"!==typeof b&&null!==b&&b.fireEvent("click")})},_appendAlert:function(b){var a=this.alertsContainer.getChildren(),c=!0;a.length&&a.each(function(a){var e=a.getElement("span.status-count"),g=!1;e||(e=new Element("span.status-count",{text:" x 1"}),e.set("data-count",1));g=parseInt(e.get("data-count"),10);b.get("data-text")===a.get("data-text")&&(g+=1,e.set("text","x "+g),e.set("data-count",g),g&&a.grab(e),c=!1)});c&&this.alertsContainer.grab(b,"top");
$("libraryContent").scrollTo(0,0)},appendAlertMessage:function(b,a){var c=Utils.createAlert(a||"error",b);this._appendAlert(c)},createUploader:function(){function b(b){c[b]||(c[b]=new UploadingItem(d[b]),c[b].element.inject(a.browseWindow,"top"),a.events.fireEvent("itemCountChanged"));return c[b]}var a=this,c={},d={},e=new FileDropUploader({uploadUrl:this.uploadUrl,container:this.mediaUploadArea});(new MediaItemUploader(e,{mediaFilterName:this.mediaFilterName})).addEvent("added",function(c,f,e){d[c]=
e;a._toggleView(!0);a._selectFilter("all");b(c).setFilename(f)}).addEvent("error",function(d,f,e,m){null!==d&&(b(d).dispose(),delete c[d]);m&&m.fireEvent("deleted");e&&(d=Utils.createAlert("error",e),a._appendAlert(d),a._toggleView(!0))}).addEvent("progress",function(a,c,d){b(a).setFilename(c).setProgress(d)}).addEvent("upload",function(a,d){this.addItem(d,!1,b(a).element);delete c[a]}.bind(this))},addItem:function(b,a,c){var d=this;b.setContext(d);var e=b.getLargestImageSize("standard"),g=b.createDisplay(e,
!0),e=g.getElement();a&&e.hide();"element"==typeOf(c)?e.replaces(c):e.inject(d.browseWindow,c||"top");g.addEvent("select",function(a){d._loaded&&d.events.fireEvent("itemSelected",a)});b.addEvent("deleted",function(){d._loaded&&(d.removeItem(this),d.thumbnails.erase(g))});d.mediaItems.push(b);d.thumbnails.push(g);d.events.fireEvent("itemCountChanged");$("libraryContent").focus();return b},removeItem:function(b){this.events.fireEvent("itemCountChanged");this.mediaItems.erase(b);(new Request.AjaxIO("removeFromLibrary",
{})).send(b.getID(),b.getType())},setupSorting:function(){var b={filename:function(a,b){var c=a.mediaItem.data.filename(),f=b.mediaItem.data.filename();return c.localeCompare(f)},date:function(a,b){var c=a.mediaItem.data.date(),f=b.mediaItem.data.date();return c<f?1:c>f?-1:0}},a=this,c=$$(".sortOption");c.addEvent("click",function(d){var e=d.target.get("data-comparator");a.setSortComparator(b[e]);c.removeClass("active");d.target.addClass("active")})},setSortComparator:function(b){this.thumbnails.sort(b);
var a=this;this.thumbnails.each(function(b){a.browseWindow.grab(b.getElement(),"bottom")})},getMenuItems:function(b){return{copy:!1}},getItemCount:function(){return $$("#mediaBrowse > .mediaItem").filter(function(b,a){return"none"!=b.getStyle("display")}).length},_toggleView:function(){var b=!0;return function(a){b=arguments.length?a:!b;$("mediaLibrary").toggle(b);$("addMedia").toggle(!b);var c=$("addMedia").parentElement;b?c.setStyle("max-width",""):c.setStyle("max-width","663px")}}(),_initNavigation:function(){$$(".mediaManagerNav").addEvent("click",
function(b){this._toggleView()}.bind(this));$$("#emptyBrowseNotice button").addEvent("click",function(b){this._toggleView()}.bind(this))},_initFilters:function(){var b=this;$$(".itemFilter").addEvent("click",function(a){b._selectFilter(this.get("data-filter"))});b._selectFilter(b.itemFilter);var a=$("emptyBrowseNotice"),c=$("mediaItemCount");b.events.addEvent("itemCountChanged",function(){var d=b.getItemCount(),e=0===d;c.set("text",d);a.toggle(e)})},_selectFilter:function(b){var a=$$(".itemFilter"),
c=this;c.dismissAlerts();a.each(function(a){var e=a.get("data-filter")===b;a.toggleClass("active",e);e&&(c._deleteAll.set("html",a.get("data-deleteAllText")),c.itemFilter=a.get("data-filter"))});a=$E(".itemFilter.active").get("text");$E(".js-current-display-name").set("text",a);a=$E(".sortOption.active").get("text");$E(".js-current-sort-name").set("text",a);c.browseWindow.set("class",b);c.events.fireEvent("itemCountChanged")},_setupDeleteAll:function(){var b=this._deleteAll,a=this,c=!1;this.events.addEvent("itemCountChanged",
function(){b.toggle(0<a.getItemCount())});b.hide();b.addEvent("click",function(b){b.stop();if(!c){c=!0;b=$$(".itemFilter.active").pick().get("text").toLowerCase();var e=_js("Are you sure you want to delete ALL your ");b=Utils.createAlertPrompt("notice",e+("all"===b?"media":b)+"?",function(b){c=!1;b&&a.mediaItems.clean().each(function(b){var c=a.itemFilter;"all"!==c&&c!==b.getFilter()||b.deleted()})});a._appendAlert(b)}})}};Object.append(MediaLibrary,Utils.EventsFunctions);MediaLibrary.initialize();
(function(b,a){"function"==typeof define&&define.amd?define(["exports"],function(c){a(b,c)}):"undefined"!==typeof exports?a(b,exports):a(b,b.fd=b.fd||{})})(this,function(b,a){a.randomID=function(a){return(a||"fd")+"_"+(1E4*Math.random()).toFixed()};a.uniqueID=function(b){do var d=a.randomID(b);while(a.byID(d));return d};a.byID=function(b){return a.isTag(b)?b:document.getElementById(b)};a.isTag=function(a,b){return"object"==typeof a&&a&&1==a.nodeType&&(!b||a.tagName.toUpperCase()==b.toUpperCase())};
a.newXHR=function(){try{return new XMLHttpRequest}catch(a){for(var b="MSXML2.XMLHTTP.6.0 MSXML2.XMLHTTP.5.0 MSXML2.XMLHTTP.4.0 MSXML2.XMLHTTP.3.0 MSXML2.XMLHTTP Microsoft.XMLHTTP".split(" "),e=0;e<b.length;e++)try{return new ActiveXObject(b[e])}catch(g){}}throw"Cannot create XMLHttpRequest.";};a.isArray=function(a){return"[object Array]"===Object.prototype.toString.call(a)};a.toArray=function(b,d){if(null===b||"undefined"==typeof b)return[];a.isArray(b)||"object"==typeof b&&"callee"in b||(b=[b]);
return Array.prototype.slice.call(b,d||0)};a.addEvent=function(a,b,e){a&&b&&e&&(a.attachEvent?(a["e"+b+e]=e,a[b+e]=function(){a["e"+b+e](window.event)},a.attachEvent("on"+b,a[b+e])):a.addEventListener(b,e,!1));return a};a.stopEvent=function(a){a.cancelBubble=!0;a.returnValue=!1;a.stopPropagation&&a.stopPropagation();a.preventDefault&&a.preventDefault();return a};a.setClass=function(b,d,e){(b=a.byID(b))&&null!=d&&("undefined"==typeof e||e?a.hasClass(b,d)||(b.className+=" "+d):b.className=b.className.replace(a.classRegExp(d),
" "));return b};a.hasClass=function(b,d){return a.classRegExp(d).test((a.byID(b)||{}).className)};a.classRegExp=function(a){return""==a||"object"==typeof a?/$o_O/:new RegExp("(^|\\s+)"+a+"(\\s+|$)","gi")};a.extend=function(a,b,e){a=a||{};b=b||{};for(var g in b)if(e||"undefined"==typeof a[g])a[g]=b[g];return a};a.callAll=function(b,d,e){var g;d=a.toArray(d);"function"==typeof b&&(b=[b]);if(a.isArray(b))for(var f=0;f<b.length&&("function"!=typeof b[f]||(g=b[f].apply(e||this,d),null==g));f++);else if(b)throw"FileDrop event list must be either an Array, Function, undefined or null but "+
typeof b+" was given.";return g};a.callAllOfObject=function(b,d,e){a.logging&&a.hasConsole&&(console.info("FileDrop "+d+" event ("+(b.events[d]?b.events[d].length||0:0)+") args:"),console.dir([e]));var g=[a.onObjectCall].concat(b.events.any),g=a.callAll(g,[d].concat(a.toArray(e)),b);return null!=g?g:a.callAll(b.events[d],e,b)};a.appendEventsToObject=function(b,d){if(a.addEventsToObject(this,!1,arguments))return this;switch(arguments.length){case 0:return a.extend({},this.events);case 1:if(null===
b)return this.events={},this;if(a.isArray(b)){for(var e={},g=0;g<b.length;g++)e[b[g]]=a.toArray(this.events[b[g]]);return e}if("function"==typeof b)return a.funcNS(b);if("string"==typeof b)return a.toArray(this.events[b]);case 2:if(b=a.toArray(b),null===d){for(g=0;g<b.length;g++)if(e=a.splitNS(b[g]),!e[0])for(var f in this.events)arguments.callee.call(this,[f+":"+e[1]],null);else if(!e[1])this.events[e[0]]=[];else if(this.events[e[0]])for(var h=this.events[e[0]].length-1;0<=h;h--)a.funcNS(this.events[e[0]][h])==
e[1]&&this.events[e[0]].splice(h,1);return this}}throw"Bad parameters for FileDrop event().";};a.previewToObject=function(b,d){if(a.addEventsToObject(this,!0,arguments))return this;throw"Bad parameters for FileDrop preview().";};a.addEventsToObject=function(b,d,e){var g=e[0],f=e[1];switch(e.length){case 1:if(g&&"object"==typeof g&&!a.isArray(g)){for(var h in g)arguments.callee(b,d,[h,g[h]]);return!0}case 2:if("function"==typeof f||a.isArray(f)){g=a.toArray(g);f=a.toArray(f);h=d?"unshift":"push";for(var m=
0;m<g.length;m++){for(var n=a.splitNS(g[m]),l=0;l<f.length;l++)a.funcNS(f[l],n[1]);b.events[n[0]]=b.events[n[0]]||[];b.events[n[0]][h].apply(b.events[n[0]],f)}return!0}}};a.funcNS=function(b,d){if("function"!=typeof b)return b;if(1==arguments.length)return(b[a.nsProp]||"").toString();b[a.nsProp]=(d||"").toString();return b};a.splitNS=function(a){return(a||"").match(/^([^:]*):?(.*)$/).slice(1)};a.extend(a,{logging:!0,hasConsole:"console"in window&&console.log&&console.dir,onObjectCall:null,all:[],
isIE6:/\bMSIE 6/.test(navigator.userAgent),isIE9:/\bMSIE 9/.test(navigator.userAgent),isChrome:-1!=(navigator.vendor||"").indexOf("Google"),nsProp:"_fdns"});a.DropHandle=function(b,d){var e=this;e.el=b=a.byID(b);if(!b)throw"Cannot locate DOM node given to new FileDrop class.";e.opt={zoneClass:"fd-zone",inputClass:"fd-file",iframe:{url:"",callbackParam:"fd-callback",fileParam:"fd-file"},input:null,recreateInput:!0,fullDocDragDetect:!1,multiple:!1,dropEffect:"copy"};a.all.push(e);e.filedrop=null;var g=
e.opt.iframe;a.extend(e.opt,d,!0);a.extend(e.opt.iframe,g);a.isChrome&&(e.opt.fullDocDragDetect=!0);e.events={any:[],dragEnter:[],dragLeave:[],dragOver:[],dragEnd:[],dragExit:[],upload:[],uploadElsewhere:[],inputSetup:[],iframeSetup:[],iframeDone:[]};e.on=e.events;e.zone=e.el;e.hook=function(b){0!=e.opt.input&&(e.opt.input=e.opt.input||e.prepareInput(b),e.opt.input&&a.callAllOfObject(e,"inputSetup",e.opt.input));e.hookDragOn(b);e.hookDropOn(b);e.hookPaste(b)};e.hookDragOn=function(b){e.opt.fullDocDragDetect?
(e.delegate(document.body,"dragEnter"),a.addEvent(document,"dragleave",function(b){if(0==b.clientX&&0==b.clientY||a.isTag(b.relatedTarget,"html"))a.stopEvent(b),a.callAllOfObject(e,"dragLeave",b)})):(e.delegate(b,"dragEnter"),e.delegate(b,"dragLeave"));e.delegate(b,"dragOver");e.delegate(b,"dragEnd");e.delegate(b,"dragExit")};e.hookDropOn=function(b){a.isIE9||e.delegate(b,"drop","upload")};e.hookPaste=function(a){e.delegate(a,"paste","upload")};e.delegate=function(b,c,d){a.addEvent(b,c.toLowerCase(),
function(b){a.stopEvent(b);a.callAllOfObject(e,d||c,b)})};e.prepareInput=function(b){if(b=e.findInputRecursive(b)||e.createInputAt(b)){for(var c=b.parentNode;c&&!a.isTag(c,"form");)c=c.parentNode;if(!c)throw"FileDrop file input has no parent form element.";var d=c?c.getAttribute("target"):"";if(d&&a.isTag(a.byID(d),"iframe"))return{file:b,form:c}}return!1};e.findInputRecursive=function(b){for(var c=0;c<b.childNodes.length;c++){var d=b.childNodes[c];if(a.isTag(d,"input")&&"file"==d.getAttribute("type")&&
a.hasClass(d,e.opt.inputClass)||(d=arguments.callee(d)))return d}};e.createInputAt=function(b){do var c=a.randomID();while(a.byID(c));var d=document.createElement("div");d.innerHTML='<iframe src="javascript:false" name="'+c+'"></iframe><form method="post" enctype="multipart/form-data"><input type="hidden" name="'+e.opt.iframe.callbackParam+'" /><input type="file" name="'+e.opt.iframe.fileParam+'" /></form>';d.firstChild.setAttribute("id",c);d.firstChild.style.display="none";d.lastChild.setAttribute("target",
c);for(c=b.firstChild;c&&(!a.isTag(c)||a.isTag(c,"legend"));)c=c.nextSibling;c?b.insertBefore(d,c):b.appendChild(d);return d.lastChild.lastChild};e.abortIFrame=function(){if(e.opt.input.form){var b=a.byID(e.opt.input.form.getAttribute("target"));b&&b.setAttribute("src","javascript:false")}};e.sendViaIFrame=function(b){b=b||e.opt.iframe.url;var c=(e.opt.input||{}).form;if(b&&c){do var d=a.randomID();while(d in window);window[d]=function(c){"object"!=typeof c&&(c={response:c,responseXML:"",responseText:(c||
"").toString(),readyState:4,status:200,statusText:"OK",getAllResponseHeaders:function(){return""},getResponseHeader:function(){return""},setRequestHeader:function(){return this},statusCode:function(){return this},abort:function(){return this}});a.extend(c,{iframe:!0,url:b});a.callAllOfObject(e,"iframeDone",c)};for(var g=c.firstChild;g&&(!a.isTag(g,"input")||g.name!=e.opt.iframe.callbackParam);)g=g.nextSibling;g?g.value=d:b=b.replace(/[?&]+$/,"")+(-1==b.indexOf("?")?"?":"&")+e.opt.iframe.callbackParam+
"="+d;c.setAttribute("action",b);a.callAllOfObject(e,"iframeSetup",c);c.submit();setTimeout(e.resetForm,300);return!0}};e.resetForm=function(){var b=e.opt.input&&e.opt.input.file;if(b&&(b.value="",e.opt.recreateInput)){var c=e.opt.input.file=b.cloneNode(!0);b.parentNode.replaceChild(c,b);a.callAllOfObject(e,"inputSetup",[e.opt.input,b])}};e.multiple=function(a){e.opt.input&&"undefined"!=typeof a&&(a?e.opt.input.file.setAttribute("multiple","multiple"):e.opt.input.file.removeAttribute("multiple"));
return e.opt.input&&!!e.opt.input.file.getAttribute("multiple")};e.event=function(b,c){return a.appendEventsToObject.apply(e,arguments)};e.preview=function(b,c){return a.previewToObject.apply(e,arguments)};e.onInputSetup=function(d,g){g?(d.file.clearAttributes&&d.file.clearAttributes(),d.file.mergeAttributes&&d.file.mergeAttributes(g)):e.multiple(e.opt.multiple);a.setClass(d.file,e.opt.inputClass);e.delegate(d.file,"change","upload");var m=d.file.parentNode;m&&m.style.display.match(/^(static)?$/)&&
(m.style.position="relative");a.isTag(b,"fieldset")&&(m=document.createElement("div"),m.style.position="relative",m.style.overflow="hidden",b.parentNode.insertBefore(m,b),m.appendChild(b))};e.onDragOver=function(b){a.stopEvent(b);b.dataTransfer&&(b.dataTransfer.dropEffect=e.opt.dropEffect)};e.onUpload=function(){for(var b=0;b<a.all.length;b++)a.all[b]!==e&&a.all[b].events&&a.callAllOfObject(a.all[b],"uploadElsewhere",e)};e.event({inputSetup:e.onInputSetup,dragOver:e.onDragOver,upload:e.onUpload});
a.setClass(b,e.opt.zoneClass);e.hook(b)};a.FileDrop=function(b,d){function e(d){return function(){a.setClass(b,g.opt.dragOverClass,d)}}var g=this;b=a.byID(b);g.handle=new a.DropHandle(b,d);g.handle.filedrop=g;a.extend(g.handle.opt,{dragOverClass:"over"});a.extend(g.handle.opt.iframe,{force:!1});a.extend(g.handle.events,{send:[],fileSetup:[]});g.onUpload=function(b){(b=!g.opt.iframe.force&&g.eventFiles(b,!0))?0<b.length&&a.callAllOfObject(g,"send",[b]):!g.handle.sendViaIFrame()&&a.hasConsole&&console.warn("FileDrop fallback upload triggered but iframe options were not configured - doing nothing.")};
g.eventFiles=function(b,c){if("paste"===b.type)return g.handlePaste(b);var d,e=new a.FileList(b);if(d=(d=b.dataTransfer)&&(d.length||d.files)?d:b.target&&b.target.files||b.srcElement&&b.srcElement.files){var l=d.items||[];d.files&&(d=d.files);for(var q={},p=0;p<d.length;p++){var r=new a.File(d[p]);q[r.name]&&"image.jpg"!=r.name||(q[r.name]=!0,r.setNativeEntry(l[p]),a.callAllOfObject(g,"fileSetup",r),(0<r.size||r.nativeEntry)&&e.push(r))}}else c&&(e=!1);return e};g.handlePaste=function(b){var c,d=
new a.FileList(b),e=/image.*/;Array.each(b.clipboardData.types,function(l,q){var p=b.clipboardData.items||[];if(l.match(e)||p[q].type.match(e)){var r=p[q].getAsFile(),t=r.type.replace("image/","");r.name="Pasted-From-Clipboard."+t;c=new a.File(r);c.setNativeEntry(p[q]);a.callAllOfObject(g,"fileSetup",c);(0<c.size||c.nativeEntry)&&d.push(c)}});return d};a.extend(g,g.handle);g.event({upload:g.onUpload,send:g.resetForm,dragEnter:e(!0),dragLeave:e(!1),uploadElsewhere:e(!1)});g.preview({upload:e(!1)})};
a.FileList=function(b){var d=this;d.dropEffect=b&&b.dropEffect||"";d.length=0;b=null;d.push=function(a){d[d.length++]=a;return d};d.pop=function(){if(0<d.length){var a=d.last();delete d[--d.length];return a}};d.first=function(){return d[0]};d.last=function(){return d[d.length-1]};d.remove=function(a){for(;a<d.length-1;a++)d[a]=d[a+1];se.f.pop();return d};d.clear=function(){for(var a=0;a<d.length;a++)delete d[a];d.length=0;return d};d.reverse=function(){for(var a=0;a<Math.floor(d.length/2);a++)d[a]=
d[d.length-a-1];return d};d.concat=function(b){for(var c=new a.FileList,f=0;f<d.length;f++)c[f]=d[f];for(f=0;b&&f<b.length;f++)c[d.length+f+1]=b[f];c.length=d.length+(b||[]).length;return d};d.sort=function(a,b){for(var c=0;c<d.length;c++)for(var h=0;h<d.length;h++)if(0>a.call(b||this,d[c],d[h],c,h)){var m=d[c];d[c]=d[h];d[h]=m}return d};d.sortBy=function(a,b){for(var c=[],h=0;h<d.length;h++)c.push([h,a.call(b||this,d[h],h)]);c.sort(function(a,b){return a[1]>b[1]?1:a[1]<b[1]?-1:0});for(h=0;h<c.length;h++)d[h]=
c[h][0];return d};d.find=function(a,b){for(var c=0;c<d.length;c++)if(null!=a.call(b||this,d[c],c))return d[c]};d.each=function(a,b){d.find(function(){a.apply(this,arguments)},b);return d};d.invoke=function(b,c){var d=a.toArray(arguments,1);return this.each(function(a){a[b].apply(a,d)})};d.abort=function(){return this.invoke("abort")};d.findCompare=function(a,b){var c;d.each(function(a){c=a},b);return c};d.filter=function(b,c){var f=new a.FileList;d.each(function(a){b.apply(this,arguments)&&f.push(a)},
c);return f};d.largest=function(){return d.findCompare(function(a){return a.size})};d.smallest=function(){return d.findCompare(function(a){return-a.size})};d.oldest=function(){return d.findCompare(function(a){return-a.modDate.getTime()})};d.newest=function(){return d.findCompare(function(a){return a.modDate})};d.ofType=function(a){a+=-1==a.indexOf("/")?"/":"$";a=new RegExp("^"+a,"i");return d.filter(function(b){return a.test(b.type)})};d.images=function(){return d.ofType("image")};d.named=function(a){return"string"==
typeof a?d.find(function(b){return b.name==a}):d.filter(function(b){return a.test(b.name)})}};a.FileList.prototype.length=0;a.FileList.prototype.splice=Array.prototype.splice;a.File=function(b){var d=this;d.nativeFile=b;d.nativeEntry=null;d.name=b.fileName||b.name||"";d.size=b.fileSize||b.size||0;d.type=d.mime=b.fileType||b.type||"";d.modDate=b.lastModifiedDate||new Date;d.xhr=null;d.opt={extraHeaders:!0,xRequestedWith:!0,method:"POST"};d.events={any:[],xhrSetup:[],xhrSend:[],progress:[],done:[],
error:[]};d.events.sendXHR=d.events.xhrSend;d.abort=function(){d.xhr&&d.xhr.abort&&d.xhr.abort();return d};d.sendTo=function(b,c){c=a.extend(c,d.opt);c.url=b;if(d.size)if(5E7>d.size&&window.FileReader){var f=new FileReader;f.onload=function(a){d.sendDataReadyTo(c,a)};f.onerror=function(b){a.callAllOfObject(d,"error",[b])};f.readAsArrayBuffer(d.nativeFile)}else d.sendDataReadyTo(c);else a.hasConsole&&console.warn("Trying to send an empty FileDrop.File.");return d};d.sendDataReadyTo=function(b,c){d.abort();
d.xhr=a.newXHR();d.hookXHR(d.xhr);d.xhr.open(b.method,b.url,!0);d.xhr.overrideMimeType&&d.xhr.overrideMimeType("application/octet-stream");d.xhr.setRequestHeader("Content-Type","application/octet-stream");if(b.extraHeaders){d.xhr.setRequestHeader("X-File-Name",encodeURIComponent(d.name));d.xhr.setRequestHeader("X-File-Size",d.size);d.xhr.setRequestHeader("X-File-Type",d.type);d.xhr.setRequestHeader("X-File-Date",d.modDate.toGMTString());var f=b.xRequestedWith;!0===f&&(f="FileDrop-XHR-"+(window.FileReader?
"FileAPI":"Webkit"));f&&d.xhr.setRequestHeader("X-Requested-With",f)}a.callAllOfObject(d,"xhrSetup",[d.xhr,b]);a.callAllOfObject(d,"xhrSend",[d.xhr,c&&c.target&&c.target.result?c.target.result:d.nativeFile,b]);return d.xhr};d.hookXHR=function(b){var c=b.upload||b;b.onreadystatechange=function(c){if(4==b.readyState){try{var g=200==b.status?"done":"error"}catch(m){g="error"}a.callAllOfObject(d,g,"error"==g?[c,b]:[b,c])}};c.onprogress=function(c){a.callAllOfObject(d,"progress",[c.lengthComputable?c.loaded:
null,c.total||null,b,c])}};d.readData=function(a,b,c){return d.read({onDone:a,onError:b,func:c})};d.readDataURL=function(a,b){return d.readData(a,b||!1,"uri")};d.readDataURI=d.readDataURL;d.read=function(b){function c(a,d){"object"==typeof d||(d.message=d);d.fdError=a;!1!==b.onError&&(b.onError||b.onDone).apply(this,arguments)}a.extend(b,{onDone:new Function,onError:null,blob:d.nativeFile,func:"",start:0,end:null,mime:""});if(!window.FileReader)return c("support",{message:"FileReader not defined"});
if(0<b.start||null!=b.end&&b.end)b.blob.slice?(null==b.end&&(b.end=b.blob.size||b.blob.fileSize),b.blob=b.blob.slice(b.start,b.end,b.mime)):a.hasConsole&&console.warn("File Blob/slice() are unsupported - operating on entire File.");var f=new FileReader;f.onerror=function(a){c("read",a)};f.onload=function(a){if(a.target&&a.target.result)"readAsBinaryString"==b.func&&(a.target.result=String.fromCharCode.apply(null,new Uint8Array(a.target.result))),b.onDone(a.target.result);else f.onerror(a)};var h=
b.func;if(a.isArray(h)){var m=h[0];h[0]=b.blob;return f[m].apply(f,h)}if(!h||"bin"==h)h="readAsBinaryString";else if("url"==h||"uri"==h||"src"==h)h="readAsDataURL";else if("array"==h)h="readAsArrayBuffer";else if("text"==h)h="readAsText";else if("read"!=h.substr(0,4))return f.readAsText(b.blob,h);"readAsBinaryString"==h&&(h="readAsArrayBuffer");return f[h](b.blob)};d.listEntries=function(b,c){if(d.nativeEntry&&d.nativeEntry.isDirectory){var f=function(a){n-=a;0==n&&b&&(b(m),b=null)};c=c||new Function;
var h=d.nativeEntry.createReader(),m=new a.FileList,n=0;h.readEntries(function(b){for(var d=0;d<b.length;d++){var e=b[d];e.file?(n++,e.file(function(b){b=new a.File(b);b.setNativeEntry(e);m.push(b);f(1)},function(){m.push(a.File.fromEntry(e));f(1);c.apply(this,arguments)})):m.push(a.File.fromEntry(e))}d?h.readEntries(arguments.callee,c):f(0)},c);return!0}};d.setNativeEntry=function(a){d.nativeEntry=a&&a.webkitGetAsEntry&&a.webkitGetAsEntry()};d.event=function(b,c){return a.appendEventsToObject.apply(d,
arguments)};d.preview=function(b,c){return a.previewToObject.apply(d,arguments)};d.onXhrSend=function(a,b){a.send(b)};d.event({xhrSend:d.onXhrSend})};a.File.fromEntry=function(b){var d=new a.File(b);d.setNativeEntry(b);d.nativeFile=null;return d};a.jQuery=function(b){b=b||jQuery||window.jQuery;if(!b)throw"No window.jQuery object to integrate FileDrop into.";b.fn.filedrop=function(d){function e(b,c){return function(d){var f=(c||[]).concat(a.toArray(arguments,1));return g.triggerHandler((b+d).toLowerCase(),
f)}}var g=this,f=this.data("filedrop");if("string"==typeof d)if(f)if("undefined"==typeof f[d])b.error("There's no method or property FileDrop."+d+".");else{var h=f[d];return"function"==typeof h?h.apply(f,a.toArray(arguments,1)):h}else b.error("$.filedrop('comment') needs an initialized FilrDrop on this element.");else if(d&&"object"!=typeof d)b.error("Invalid $.filedrop() parameter - expected nothing (creates new zone), a string (property to access) or an object (custom zone options).");else if(f)if(d)a.extend(f.opt,
d,!0);else return f;else f=new FileDrop(this[0],d),f.$el=b(this),this.first().data("filedrop",f),f.event("any",e("fd")),f.on.fileSetup.push(function(a){a.event("any",e("file",[a]))});return g}};b.FileDrop=a.FileDrop});
FileDropUploader=new Class({Implements:[Options,Events],options:{uploadUrl:"",container:null},initialize:function(b){var a=this,c=Object.keys(MediaLibrary.imageExtensions),d=Object.keys(MediaLibrary.documentExtensions),e=Object.keys(MediaLibrary.videoExtensions);c.concat(d,e);var c=c.join(", ").toUpperCase(),d=d.join(", ").toUpperCase(),e=e.join(", ").toUpperCase(),g=_js("File size limit: %1 MB. Video length limit: %2 seconds.").replace("%1",App.maxMediaSize).replace("%2",App.maxMediaLength);this.setOptions(b);
_js("browse");var f=Date.now(),h=function(){return a.options.uploadUrl+"?uploadBatchId="+f+"&csrf="+CSRF.get()};b=Template.get('<div id="file-drop" class="mm-uploader">\n   <i class="fa fa-file-pdf-o " ></i>   <i class="fa fa-file-image-o " ></i>   <i class="fa fa-file-video-o " ></i>   <h3 class="add-media-text">\n            Drag &amp; drop here <br><a class="mediaButton qq-upload-button" id="addMedia">or browse for files</a>   </h3>\n</div>\n')({imageExtensionText:c,documentExtensionText:d,videoExtensionText:e,
limitMessage:g});b.inject(this.options.container);var m=function(a){var b=0,c=[];return{send:function(d){b<a?(b++,window.setTimeout(d)):c.push(d)},next:function(){b--;if(0<c.length){var a=c.pop();b++;window.setTimeout(a)}}}}(3);window.fd.logging=!1;$("addMedia");c=function(b,c){var d={multiple:!mobileDetected()&&!tabletDetected()};c?d.iframe={url:h(),callbackParam:"fd-callback",fileParam:"file"}:d.input=!1;var d=new FileDrop(b,d),e=function(b,c){b.event("progress",function(d,f){a.fireEvent("progress",
[c,b.name,d&&f&&d/f||0])});b.event("done",function(d){m.next();d=JSON.parse(d.response);var f=_js("Unknown error while uploading file: %1").replace("%1",b.name);if(d&&d.success)a.fireEvent("upload",[c,b.name,d]);else{if(d&&d.error){var e=d.error;d.filename&&e.message?f=d.filename+": "+e.message:d.filename?f=_js("Unknown error while uploading file: %1").replace("%1",d.filename):e.message&&(f=b.name+": "+e.message)}a.fireEvent("error",[c,b.name,f])}});b.event("error",function(d,f){var e=_js("Unknown error while uploading file: %1").replace("%1",
b.name);a.fireEvent("error",[c,b.name,e]);m.next()});m.send(function(){b.sendTo(h()+"&file="+encodeURIComponent(b.name)+"&uploadIndex="+encodeURIComponent(c))});a.fireEvent("added",[c,b.name,b.abort.bind(b)])};d.event("send",function(a){f=Date.now();a.each(e)});d.event("iframeSetup",function(b){b.action=h();a.fireEvent("added",["a","uploading",null]);a.fireEvent("progress",["a","uploading",0])});d.event("iframeDone",function(b){if(b.error){var c=b.error;c&&b.filename&&c.message&&(c=b.filename+": "+
c.message);a.fireEvent("error",["a",b.filename,c])}else a.fireEvent("upload",["a","uploading",b])});return d};c(b,!0);c($("libraryContent"))}});
MediaItemUploader=new Class({_items:{},Implements:[Options,Events],initialize:function(b,a){this.setOptions(a);b.addEvent("upload",function(a,d,e){var g=new Future,f=MediaItem.createFromData(e,{},g);g.getValue(function(a,c){c&&b.fireEvent("error",[e.imageid,e.filename,c,f])});(new Request.AjaxIO("isMediaItemReady",{onComplete:function(a){a.error?g.error(a.error):g.resolve(a)}})).ping(e.guid,e.type,this.options.mediaFilterName);this.fireEvent("upload",[a,f,d])}.bind(this));Utils.passEvent("added",
b,this);Utils.passEvent("error",b,this);Utils.passEvent("progress",b,this);Utils.passEvent("clobber",b,this)}});
UploadingItem=new Class({initialize:function(b){var a=this,c=this.element=new Element("div.mediaItem.uploading"),d=this.spacer=new Element("div.spacer"),e=this.fileEl=new Element("span.file-container"),g=this.filenameEl=new Element("span.filename"),f=this.filetypeEl=new Element("span.filetype"),h=this.percentEl=new Element("span.percent"),m=this.percentBar=new Element("div.percentBar");d.grab(h);d.grab(m);b&&(h=(new Element("div.cancel.close")).set("html","&times;").addEvent("click",function(){a.dispose();
b()}),d.grab(h));c.grab(d);e.grab(g);e.grab(f);c.grab(e);this.setProgress(0)},setFilename:function(b){b&&!this._filenameSet&&(this._filenameSet=!0,this.filenameEl.set({text:b,title:b}),b=b.match(/\.[^.]+$/))&&(b=MediaLibrary.allExtensions[b[0].substring(1).toLowerCase()],this.element.addClass({i:"mediaImage",v:"mediaVideo",d:"mediaDocument"}[b]));return this},setProgress:function(b){var a=Math.round(100*b)+"%";this.percentEl.set("text",a);this.percentBar.setStyle("width",a);1<=b&&this.clearProgress();
return this},dispose:function(){this.element.dispose()},clearProgress:function(){var b=this;b.element.addClass("mediaItemProcessing");TweenMax.to(b.spacer,.5,{opacity:0});setTimeout(function(){b.percentBar.dispose();b.percentEl.dispose();b.spacer.dispose()},1E3);return b}});
(function(b){var a={VERSION:"2.2.0",Result:{SUCCEEDED:1,NOTRANSITION:2,CANCELLED:3,ASYNC:4},Error:{INVALID_TRANSITION:100,PENDING_TRANSITION:200,INVALID_CALLBACK:300},WILDCARD:"*",ASYNC:"async",create:function(b,d){var e="string"==typeof b.initial?{state:b.initial}:b.initial,g=d||b.target||{},f=b.events||[],h=b.callbacks||{},m={},n=function(b){var c=b.from instanceof Array?b.from:b.from?[b.from]:[a.WILDCARD];m[b.name]=m[b.name]||{};for(var d=0;d<c.length;d++)m[b.name][c[d]]=b.to||c[d]};e&&(e.event=
e.event||"startup",n({name:e.event,from:"none",to:e.state}));for(var l=0;l<f.length;l++)n(f[l]);for(var q in m)m.hasOwnProperty(q)&&(g[q]=a.buildEvent(q,m[q]));for(q in h)h.hasOwnProperty(q)&&(g[q]=h[q]);g.current="none";g.is=function(a){return this.current==a};g.can=function(b){return!this.transition&&(m[b].hasOwnProperty(this.current)||m[b].hasOwnProperty(a.WILDCARD))};g.cannot=function(a){return!this.can(a)};g.error=b.error||function(a,b,c,d,f,e,g){throw g||e;};if(e&&!e.defer)g[e.event]();return g},
doCallback:function(b,d,e,g,f,h){if(d)try{return d.apply(b,[e,g,f].concat(h))}catch(m){return b.error(e,g,f,h,a.Error.INVALID_CALLBACK,"an exception occurred in a caller-provided callback function",m)}},beforeEvent:function(b,d,e,g,f){return a.doCallback(b,b["onbefore"+d],d,e,g,f)},afterEvent:function(b,d,e,g,f){return a.doCallback(b,b["onafter"+d]||b["on"+d],d,e,g,f)},leaveState:function(b,d,e,g,f){return a.doCallback(b,b["onleave"+e],d,e,g,f)},enterState:function(b,d,e,g,f){return a.doCallback(b,
b["onenter"+g]||b["on"+g],d,e,g,f)},changeState:function(b,d,e,g,f){return a.doCallback(b,b.onchangestate,d,e,g,f)},buildEvent:function(b,d){return function(){var e=this.current,g=d[e]||d[a.WILDCARD]||e,f=Array.prototype.slice.call(arguments);if(this.transition)return this.error(b,e,g,f,a.Error.PENDING_TRANSITION,"event "+b+" inappropriate because previous transition did not complete");if(this.cannot(b))return this.error(b,e,g,f,a.Error.INVALID_TRANSITION,"event "+b+" inappropriate in current state "+
this.current);if(!1===a.beforeEvent(this,b,e,g,f))return a.CANCELLED;if(e===g)return a.afterEvent(this,b,e,g,f),a.NOTRANSITION;var h=this;this.transition=function(){h.transition=null;h.current=g;a.enterState(h,b,e,g,f);a.changeState(h,b,e,g,f);a.afterEvent(h,b,e,g,f)};this.transition.cancel=function(){h.transition=null;a.afterEvent(h,b,e,g,f)};var m=a.leaveState(this,b,e,g,f);if(!1===m)return this.transition=null,a.CANCELLED;if("async"===m)return a.ASYNC;this.transition&&this.transition();return a.SUCCEEDED}}};
"function"===typeof define?define(function(b){return a}):b.StateMachine=a})(this);(function(b){function a(){return this.__properties}b.define=function(b){function d(a){this.__properties=a||{}}function e(a){d.prototype[a]=function(b){return 0<arguments.length?(this.__properties[a]=b,this):this.__properties[a]}}for(var g=0;g<b.length;g++)e(b[g]);d.prototype._toObject=a;return d}})("object"===typeof module?module.exports:("undefined"===typeof window?this:window).StrictObject={});
MediaItem=new Class({Implements:[Options,Events],options:{enableCrop:!0,enableMarkers:!0,min:{width:800,height:600},cropMin:{width:96,height:96},ratio:"FOUR_THREE"},medium:{width:592,height:444},initialize:function(b,a,c){this.setOptions(a);this.storage=new Hash;c?(this.setData(b,!0),this.setDataPromise(c)):this.setData(b)},_setLoading:function(b){b=!!b;this.isLoading!=b&&(this.isLoading=b,this.fireEvent("loadingChanged",[b]))},setData:function(b,a){b instanceof MediaItemData||(b=new MediaItemData(b));
this.data=b;a||this.fireEvent("dataChanged",[this])},setDataPromise:function(b){var a=this;this.dataPromise=b;b.isResolved()||a._setLoading(!0);b.getValue(function(b,d){d?alert(d):a.setData(b);delete a.dataPromise;a._setLoading(!1)})},whenReady:function(b,a){if(this.dataPromise)return!this.dataPromise.isResolved()&&a&&a(),this.dataPromise.getValue(b,a);b&&b();return!0},deleted:function(){this.fireEvent("deleted",[this]);this.removeEvents()},isReady:function(){var b=this.dataPromise;return b?b.isResolved():
!0},setContext:function(b){this.context=b},getContext:function(){return this.context},getElement:function(){return this.container},_getMenuOptions:function(){return{deleted:!0,copy:!0}},getLargestImageSize:function(b){b=b?MediaItem.sizes.indexOf(b):MediaItem.sizes.length-1;for(b;0<=b;b--){var a=MediaItem.sizes[b],c=this.data;if(c[a]&&c[a]())return a}},collectMenuOptions:function(){var b=MediaItem.prototype._getMenuOptions.call(this);Object.append(b,this._getMenuOptions());this.context&&Object.append(b,
this.context.getMenuItems(this));return b},store:function(b,a){this.storage.set(b,a)},retrieve:function(b,a){var c=this.storage.get(b);!c&&a&&(c=a,this.storage.set(b,c));return c},createRepresentationFor:function(b,a){},getID:function(){},getType:function(){},getGlobalID:function(){},copyToMediaLibrary:function(){MediaItem.copyToMediaLibrary(this.getID(),this.getType())}});
MediaItem.extend({copyToMediaLibrary:function(b,a,c,d){var e=new LoadingStatus(d?d:$(document.body));e.loading(_js("Copying to library..."));(new Request.AjaxIO("copyToLibrary",{onSuccess:function(d){e.doneLoading.delay("GuideVideoObject"===a||"GuideEmbedObject"===a?1E3:0,e);c&&c(d,b)},onFailure:function(){e.doneLoading();e.loading(_js("Internal Error: Failed copying to library."));e.doneLoading.delay(3E3,e)},onError:function(a){e.doneLoading();var b=new StatusNotice;$$("#guideSteps .statuses").adopt(b.element);
b.error(a.error);b.addCloseButton()}})).send(b,a)},createMenuControl:function(b){if(b&&b.context&&b.context.options&&"all"===b.context.options.menuHide)return null;var a=new Element("div.menuControl"),c=new Element("i.fa.fa-cog"),d=new Element("div.edit-text");d.setProperties({text:"EDIT"});d.grab(c);a.grab(d);a.addEvent("click",function(c){c.stop();MediaItem.fireEvent("toggleMenu",[b,a])});a.store("mediaItem",b);return a},createFromData:function(b,a,c){b=new MediaItemData(b);return new (this.types[b.type()])(b,
a,c)},types:{},registerType:function(b,a){this.types[b]=a},sizes:"mini thumbnail standard medium large huge".split(" "),isSizeAsBigAs:function(b,a){var c=this.sizes.indexOf(a),d=this.sizes.indexOf(b);if(-1===c||-1===d)throw c=[a,b].join(),Error("One of ["+c+"] is not a valid image size.");return d>=c}});Object.append(MediaItem,Utils.EventsFunctions);MediaItemData=StrictObject.define("filename title type provider date srcid imageid encoding documentid objectid videoid document_extension document_type document_group guid ratio active mini thumbnail standard medium view_url edit_url video_urls width height markup markup_string scaled_width scaled_height filter_state html".split(" "));
MediaTarget=new Class({Implements:[Options,Events],options:{getErrorMessage:function(){return"Can't place this item here."}},element:null,mediaid:null,_isDirty:!1,initialize:function(b,a){this.element=$(b);var c=this,d=this.options;d.accepts=b.get("data-accepts");d.displaySize=b.get("data-displaySize");d.formField=$(b.get("data-formField"));d.menuHide=b.get("data-menuHide");Object.append(d,a);b.contains(d.formField)&&(this._formFieldIsInside=!0);b.store("mediaTarget",this);this._content=b.getElement(".contents");
d=this._updateFormField.bind(this);this._mediaItemEventHandlers={dataChanged:d,deleted:function(){c.attachItem(null)}};this.addEvent("itemChanged",d);b.addClass("mediaTarget");(d=b.get("data-itemData"))?(d=MediaItem.createFromData(JSON.decode(d)),this._immediatelyAttach(d),this._isDirty=!1):this._displayItem();this._initializeUI(b)},_initializeUI:function(b){var a=this;b.addEvent("click",function(){a.fireEvent("browse")})},getErrorMessage:function(b){return this.options.getErrorMessage(b)},_displayItem:function(b){var a=
this;if(b)a._displayLoading(!0),b.createRepresentationFor(a,function(b){a._itemDisplay=b;b=b.getElement();b.addClass("contents");a._content=b;a._empty();b.grab(MediaTarget.createModifyableIndicator("replaceImage",a.options.displaySize));a.element.grab(b);a._displayLoading(!1)});else{a._empty();b=new Element("div.contents");var c=this.options.displaySize,d=a.options.iconClass||"addImage";b.addClass(c);b.grab(MediaTarget.createModifyableIndicator(d,c));a.element.grab(b)}},_empty:function(){this.element.empty();
this._formFieldIsInside&&this.element.grab(this.options.formField)},_displayLoading:function(b){var a=this.element,c=this;if(b){a.pinDimensions();this.element.toggleClass("mediaItemProcessing",b);var d=this._overlay();this.element.grab(d)}else{var d=function(){c._overlay().dispose();a.unpinDimensions();c.element.toggleClass("mediaItemProcessing",b)},e=this._itemDisplay;e&&e.whenReady?e.whenReady(d):d()}},_overlay:function(){return this._overlayEl=this._overlayEl||new Element("div.loadingOverlay")},
_updateFormField:function(){if(this.options.formField){var b=this.mediaItem?this.mediaItem.getID():"";this.options.formField.set("value",b);this.fireEvent("fieldUpdated")}},attachItem:function(b,a){a=a||function(){};var c=this.options.customAttach;if(c)c.apply(this,[b,a]);else{if(b&&!1===b.data.filter_state())return a(b,!1,this.getErrorMessage(b));c=this._immediatelyAttach(b);a&&a(c,!0)}},_immediatelyAttach:function(b){var a=this._setItem(b);this._isDirty=!0;this._displayItem(b);return a},getFormField:function(){return this.options.formField},
isDirty:function(){return this._isDirty},getMenuItems:function(b){var a={detach:Auth.isLoggedIn()};this.options.menuHide.split(" ").each(function(b){a[b]=!1});return a},getMediaFilterName:function(){return this.options.accepts},_setItem:function(b){var a=null;this.mediaItem&&(this.mediaItem.removeEvents(this._mediaItemEventHandlers),this.mediaItem.setContext(),a=this.mediaItem);b&&(b.addEvents(this._mediaItemEventHandlers),b.setContext(this));this.mediaItem=b;this.fireEvent("itemChanged",[b,a]);return a},
destroy:function(){this.element.destroy()},getMediaItem:function(){return this.mediaItem}});
Object.append(MediaTarget,{registerAllTargets:function(){return $$(".mediaTarget").filter(function(b){return!b.hasClass("customSetup")}).map(function(b){return MediaTarget.createFromElement(b)})},createFromElement:function(b,a){var c=new MediaTarget(b,a);c.addEvent("browse",MediaTarget._initiateBrowsing);return c},createModifyableIndicator:function(b,a){var c=new Element("div",{"class":"alterTarget "+a+" "+b}),d=new Element("div.icon");c.grab(d);return c},_initiateBrowsing:function(){MediaManager.browse(this)}});
TextMediaTarget=new Class({name:"TextMediaTarget",Extends:MediaTarget,initialize:function(b,a){this.parent(b,a)},_initializeUI:function(b){this.addEvent("browse",MediaTarget._initiateBrowsing)},_displayItem:function(b){var a=Utils.createElements,c=this,d=a({tag:"div",c:"row attachment-container"});if(b){var e=b.data.document_group();b.data.document_extension();var g=b.data.document_type(),g=a({c:"pdf-document attachment-icon fa fa-file-"+g+"-o fa-2x officeDocumentIcon document-icon-"+g});c._empty();
var f=a({tag:"div",c:"column"}),h=a({tag:"a",href:b.data.view_url(),target:"_blank"}),m=a({tag:"p",text:b.data.title()||b.data.filename()}),n=a({tag:"a",c:"feature-doc-button button button-small button-transparent",text:_js("Feature")});b=a({tag:"a",c:"edit-doc-button button button-small button-transparent",text:_js("Edit"),href:b.data.edit_url(),target:"_blank"});var l=a({tag:"a",html:'<i class="svg-icon"   style="display: inline-block; width: 16px; height: 16px;"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">\n    <line x1="18" y1="6" x2="6" y2="18"/>\n    <line x1="6" y1="6" x2="18" y2="18"/>\n</svg></i>',
c:"removeLink delete"}).addEvent("click",function(){c.attachItem(null)}),a=a({c:"remove-doc-container"});c.element.grab(d);a.grab(l);h.grab(m);f.grab(h);d.grab(g);d.grab(f);d.grab(b);"pdf"===e&&d.grab(n);d.grab(a)}else c._empty(),e=a({tag:"a",c:"viewLink add-document hidden",text:_js("Add New")}).addEvent("browse",function(){c.fireEvent("browse")}),d.grab(e),c.element.grab(d)}});
MinimalMediaTarget=new Class({name:"MinimalMediaTarget",Implements:[Events],options:{},initialize:function(b){Object.append(this.options,b);if(!this.options.accepts)throw Error("Must provide an 'accepts' option");},attachItem:function(b,a){function c(c,f,e){f&&d.fireEvent("itemChanged",[b]);a&&a.apply(d,Array.from(arguments))}var d=this;if(b.isReady())if(!1===b.data.filter_state())c(null,!1,"Can't place media of this type.");else{var e=this.options.customAttach;e?e(b,c):c(null,!0)}else c(null,!1,
"Can't be placed until processing is finished")},getMediaFilterName:function(){return this.options.accepts}});Modal.addEvents({onImageMarkersLoad:function(b,a,c){ImageMarkers.initialize(b,a,c)},onImageMarkersUnload:function(){ImageMarkers.unload()}});
ImageMarkers=function(){var b,a=function(){this.savedShape=null};a.prototype.copy=function(a){this.savedShape=a.clone()};a.prototype.paste=function(){return this.savedShape.clone()};a.prototype.isEmpty=function(){return!this.savedShape};var c=new a,d={up:!1,down:!1,left:!1,right:!1},e=function(a){var e=b.getActiveShape();if(e||"v"===a.key)if(d.hasOwnProperty(a.key)){d[a.key]=!0;a.stop();var g=a.shift?5:1;a.control||a.alt?e.grow(d,g):e.nudge(d,g);e.canvas.renderAll()}else"delete"===a.key||"backspace"===
a.key?(b.removeShape(e),a.stop()):"-"===a.key||"="===a.key||"+"===a.key?(a.stop(),g=a.shift?6:2,g*="-"===a.key?-1:1,b.incrementSize(e,g)):"c"===a.key?(a.stop(),c.copy(e)):"v"===a.key&&(a.stop(),c.isEmpty()||(e=c.paste(),b.getMarkupObjects().push(e),b.fabricCanvas.add(e),b.fabricCanvas.setActiveObject(e),e.center(),e.setCoords(),e.canvas.renderAll()));"backspace"==a.key&&a.stop()},g=function(a){d.hasOwnProperty(a.key)&&(d[a.key]=!1)};return{thumb:{width:592,height:444},activeColor:"red",options:{ratio:"FOUR_THREE"},
showForMediaItem:function(a){Modal.open({type:"module",name:"ImageMarkers",boxClass:"mediaLibraryModalBox editPhoto",clientOptions:{mediaImage:a,ratio:this.options.ratio,min:this.options.min},serverOptions:{imageid:a.getID()}})},initialize:function(a,b,c){var d=this.mediaImage=b.mediaImage;this.sourceImageData=new MediaItemData(c.sourceImage);Object.each(c.image,function(a,b){d.data[b](a)});delete b.mediaImage;this.setOptions(b);this.container=$("imageEditContainer");this.canvas=$("imageEditCanvas");
this.fabric=null;this.setupMarkerEvents();var e=this;this.loadImage(function(a){e.setActiveMarkerOption($("shapeCircle"));a.on("object:selected",function(a){a.target&&e.setCurrentColor(a.target.color)})})},setMarkerEditable:function(a){null!=this.fabric&&this.fabric.getObjects().each(function(b){b.set("selectable",a);b.set("perPixelTargetFind",a)})},setupMarkerEvents:function(){var a=this;this.markerOptions=$$("#shapeButtons .markerButton[data-type]");var b=$$(".extras .markerButton"),c=$("moreTools");
this.activeOption=this.markerOptions.filter(".selected");this.markerOptions.addEvent("click",function(b){a.setActiveMarkerOption(this)});c.addEvent("click",function(a){b.show();this.hide()});this.markerColors=$$(".markerColor");this.markerColors.addEvent("click",function(b){a.setCurrentColor(b.target.get("data-color"))});Modal.closeConfirms.set("ImageMarkers",this.confirm.bind(this));$("imageEditButton").removeEvents().addEvent("click",this.save.bind(a));$(document).addEvent("keydown",e);$(document).addEvent("keyup",
g);clickSafe($("markersCloseBtn"),function(){Modal.cancel()});$("markerTrash").addEvent("click",function(){a.removeActiveShape()})},removeActiveShape:function(){b.removeShape(b.getActiveShape())},setActiveMarkerOption:function(a){this.fabric.deactivateAll().renderAll();this.activeOption.get("data-type")!=a.get("data-type")&&(this.activeOption=a,a=this.activeOption.get("data-type"),b.shapeCreator.setShapeMode(a),this.markerOptions.removeClass("selected"),this.activeOption.addClass("selected"),this.setMarkerEditable(!0))},
setCurrentColor:function(a){var c=$$(".markerColor[data-color="+a+"]")[0];this.selectedColor=a;this.markerColors.removeClass("selected");c.addClass("selected");(c=b.getActiveShape())&&b.setColor(c,a);b.shapeCreator.setColor(a)},confirm:function(){return this.markupString&&this.markupString!=b.getMarkupString()?confirm(_js("You have unsaved modifications. Your changes will be lost if you continue.")+"\n\nQuit without saving?"):!0},loadImage:function(a){var c=this.mediaImage,d;d=c.hasMarkers()?c.hasCrop()?
this.container.get("data-preview")+"/{i}/{m}/medium".substitute({i:c.data.srcid(),m:c.cropMarkupString()+";"+this.options.ratio}):this.sourceImageData.medium():c.getSrc("medium");this.container.setStyles({width:c.data.scaled_width(),height:c.data.scaled_height()});d=new Element("img",{src:d,"class":"sourceImage"});this.container.grab(d,"top");this.canvas.width=c.data.scaled_width();this.canvas.height=c.data.scaled_height();c=function(){this.fabric=new (require("fabric").fabric.Canvas)(this.canvas.get("id"),
{hoverCursor:"pointer",moveCursor:"move",defaultCursor:"crosshair",targetFindTolerance:1});b=require("./ImageMarkupBuilder").Builder(this.fabric);this.placeExistingMarkers();a&&a(this.fabric)}.bind(this);d.addEvent("load",c)},placeExistingMarkers:function(){var a=this.mediaImage.data,c=a.markup(),d=c.draw?{draw:c.draw}:{};d.strokeWidth=5;d.crop=c.crop;a={resizeRatio:this.canvas.get("width")/a.width(),finalDimensions:{width:this.canvas.get("width"),height:this.canvas.get("height")},instructions:d};
b.processJSON(a,function(a){this.markupString=b.getMarkupString();this.fabric.deactivateAll().renderAll();this.setMarkerEditable(!0)}.bind(this))},save:function(){var a=this.mediaImage,c=b.getMarkupString();if(this.markupString!=c){this.markupString=c;var d=new Future;a.setDataPromise(d);(new Request.AjaxIO("editImageMarkers",{onSuccess:function(b){b.error?d.error(b.error):(b.filter_state=a.data.filter_state(),d.resolve(b))}.bind(this)})).send(a.getID(),this.markupString,a.data.ratio(),!0)}Modal.pop()},
unload:function(){$(document).removeEvent("keydown",e);$(document).removeEvent("keyup",g);Modal.closeConfirms.erase("ImageMarkers");this.lastMarkup=this.markup=null}}}();Object.append(ImageMarkers,Utils.EventsFunctions);Object.append(ImageMarkers,new Options);Browser.ie&&(Element.Constructors.canvas=function(b){return new Canvas(b)});
Canvas=new Class({initialize:function(){var b=Array.link(arguments,{properties:Type.isObject,element:function(a){return null!=a}}),b=Object.append({width:300,height:150},b.properties),a=document.newElement("canvas");a.set(b);if(a.getContext)return a;a.attachEvent("onpropertychange",this.changeproperty);a.attachEvent("onresize",this.resize);a.getContext=function(){return this.context=this.context||new CanvasRenderingContext2D(a)};return a.setStyles({width:b.width,height:b.height})},changeproperty:function(b){var a=
b.propertyName;if("width"==a||"height"==a)b=b.srcElement,b.style[a]=b[a],b.getContext().clearRect()},resize:function(b){b=b.srcElement;var a=b.firstChild;a&&(a.style.width=b.width,a.style.height=b.height)}});
CanvasRenderingContext2D=new Class({initialize:function(b){this.element=(new Element("div")).setStyles({width:b.clientWidth,height:b.clientHeight}).inject(b);this.m=[[1,0,0],[0,1,0],[0,0,1]];this.rot=this.l=0;this.state=[];this.path=[];this.Z=10;this.Z2=this.Z/2;this.arcScaleY=this.arcScaleX=1;this.currentY=this.currentX=0;this.miterLimit=1*this.Z},lineWidth:1,strokeStyle:"#000",fillStyle:"#fff",globalAlpha:1,globalCompositeOperation:"source-over",lineCap:"butt",lineJoin:"miter",shadowBlur:0,shadowColor:"#000",
shadowOffsetX:0,shadowOffsetY:0,getCoords:function(b,a){var c=this.m,d=this.Z,e=this.Z2;return[d*(b*c[0][0]+a*c[1][0]+c[2][0])-e,d*(b*c[0][1]+a*c[1][1]+c[2][1])-e]}});
CanvasRenderingContext2D.implement({beginPath:function(){this.l=0;this.path.length=0},moveTo:function(b,a){this.path[this.l++]="m";this.path[this.l++]=this.coord(b,a);this.currentX=b;this.currentY=a},closePath:function(){this.path[this.l++]="x"},lineTo:function(b,a){this.path[this.l++]="l";this.path[this.l++]=this.coord(b,a);this.currentX=b;this.currentY=a},quadraticCurveTo:function(b,a,c,d){b*=2;a*=2;this.bezierCurveTo((b+this.currentX)/3,(a+this.currentY)/3,(b+c)/3,(a+d)/3,c,d)},bezierCurveTo:function(b,
a,c,d,e,g){this.path[this.l++]=" c "+[this.coord(b,a),this.coord(c,d),this.coord(e,g)].join();this.currentX=e;this.currentY=g},arcTo:Function.empty,arc:function(b,a,c,d,e,g){0===this.rot&&(c*=this.Z);var f=d.cos()*c,h=d.sin()*c,m=e.cos()*c,n=e.sin()*c;if(0!==this.rot){var l=Math.PI,q=l/24,p=g?-1:1;p*e<d&&(g?d+=2*l:e+=2*l);for(this.lineTo(f+b,h+a);p*d+q<e;)this.lineTo(b+(d+=p*q).cos()*c,a+d.sin()*c);this.lineTo(m+b,n+a)}else f!=m||g||(f+=.125),d=this.Z2,e=this.getCoords(b,a),l=this.arcScaleX*c,c*=
this.arcScaleY,this.path[this.l++]=[g?"at ":"wa ",(e[0]-l).round()+","+(e[1]-c).round()+" ",(e[0]+l).round()+","+(e[1]+c).round()+" ",this.coord(f+b-d,h+a-d)+" ",this.coord(m+b-d,n+a-d)].join("")},rect:function(b,a,c,d){this.moveTo(b,a);this.lineTo(b+c,a);this.lineTo(b+c,a+d);this.lineTo(b,a+d);this.closePath()},fill:function(){this.stroke(!0)},stroke:function(b){if(this.path.length){var a=10*this.Z,c=this.fillStyle,d=Type.isString(c),e=this.processColor(b&&d?c:this.strokeStyle),d=b?["stroked=",["<v:fill ",
d?"color="+e.color+' opacity="'+e.opacity:this.processColorObject(c),'"></v:fill>']]:["strokeweight="+.8*this.lineWidth*this.m[0][0]+" filled=",["<v:stroke","endcap=","butt"==this.lineCap?"flat":this.lineCap,"joinstyle=",this.lineJoin,"color=",e.color,'opacity="',e.opacity,'" />']];this.element.insertAdjacentHTML("beforeEnd",['<v:shape path="',this.path.join(""),'e" coordsize="'+a+","+a+'" ',d[0],'false">',d[1].join(" "),"</v:shape>"].join(""));b&&c.img&&(this.element.getLast().fill.alignshape=!1);
this.beginPath()}},clip:Function.empty,isPointInPath:Function.empty,processColor:function(b){var a=this.globalAlpha;"rgb"==b.substr(0,3)&&("a"==b.charAt(3)&&(a*=b.match(/([\d.]*)\)$/)[1]),b=b.rgbToHex());return{color:b,opacity:a}},processColorObject:function(b){var a="";if(b.addColorStop){var c=b.col0,d=b.col1,e="";if(b.stops)for(var g=0,f=b.stops.length;g<f;g++)e+=(100*b.stops[g][0]).round()+"% "+b.stops[g][1];a+=(b.r0?'type=gradientradial focusposition="0.2,0.2" focussize="0.2,0.2"':"type=gradient method=linear focus=0 angle="+
180*(1+b.angle/Math.PI)+" ")+['color="'+c.color,'opacity="'+100*c.opacity+"%",'color2="'+d.color,'o:opacity2="'+100*d.opacity+"%",'colors="'+e].join('" ')}return b.img?'type="tile" src="'+b.img.src:a},coord:function(b,a){var c=this.m,d=this.Z,e=this.Z2;return(d*(b*c[0][0]+a*c[1][0]+c[2][0])-e).round()+","+(d*(b*c[0][1]+a*c[1][1]+c[2][1])-e).round()}});
CanvasRenderingContext2D.implement({clearRect:function(b,a,c,d){this.element.innerHTML="";this.m=[[1,0,0],[0,1,0],[0,0,1]]},fillRect:function(b,a,c,d){this.rect(b,a,c,d);this.fill()},strokeRect:function(b,a,c,d){this.rect(b,a,c,d);this.stroke()}});
CanvasRenderingContext2D.implement({scale:function(b,a){this.arcScaleX*=b;this.arcScaleY*=a;this.matMult([[b,0,0],[0,a,0],[0,0,1]])},rotate:function(b){this.rot+=b;var a=b.cos();b=b.sin();this.matMult([[a,b,0],[-b,a,0],[0,0,1]])},translate:function(b,a){this.matMult([[1,0,0],[0,1,0],[b,a,1]])},transform:function(b,a,c,d,e,g){this.matMult([[b,c,e],[a,d,g],[0,0,1]])},setTransform:function(){this.m=[[1,0,0],[0,1,0],[0,0,1]];this.transform.apply(this,arguments)},matMult:function(b){for(var a=this.m,c=
[[0,0,0],[0,0,0],[0,0,0]],d=3;d--;){var e=b[0][d],g=b[1][d],f=b[2][d];e&&this.sum(c[0],this.dotmult(e,a[d]));g&&this.sum(c[1],this.dotmult(g,a[d]));f&&this.sum(c[2],this.dotmult(f,a[d]))}this.m=c},dotmult:function(b,a){return a.map(function(a){return b*a})},sum:function(b,a){b[0]+=a[0];b[1]+=a[1];b[2]+=a[2]}});
CanvasRenderingContext2D.implement({drawImage:function(b){var a=arguments,c=a.length,d=9==c?4:0,e=b.runtimeStyle,g=e.width,f=e.height;e.width="auto";e.height="auto";var h=b.width,m=b.height;e.width=g;e.height=f;var n=0,l=0,e=h,g=m,q=a[++d],p=a[++d],f=a[++d]||h,d=a[++d]||m;9==c&&(n=a[1],l=a[2],e=a[3],g=a[4]);var a=l/m,c=n/h,n=this.m,r=this.Z,q=this.getCoords(q,p).map(function(a){return(a/r).round()}),q=n[0][1]||1!=n[0][0]?["filter:progid:DXImageTransform.Microsoft.Matrix( M11=",n[0][0],"M12=",n[1][0],
"M21=",n[0][1],"M22=",n[1][1],"Dx=",q[0],"Dy=",q[1],")"].join(" "):"top:"+q[1]+";left:"+q[0];this.element.insertAdjacentHTML("beforeEnd",['<v:group style="',q,'" coordsize="',10*r,",",10*r,'">',["<v:image src=",b.src,"style=width:"+r*f+";height:"+r*d,"croptop=",a,"cropright=",1-c-e/h,"cropbottom=",1-a-g/m,"cropleft=",c,"/>"].join(" "),"</v:group>"].join(" "))},drawImageFromRect:Function.empty,getImageData:Function.empty,putImageData:Function.empty});
CanvasRenderingContext2D.implement({states:"strokeStyle fillStyle globalAlpha lineWidth lineCap lineJoin miterLimit shadowOffsetX shadowOffsetY shadowBlur shadowColor globalCompositeOperation".split(" "),save:function(){var b={};this.states.each(function(a){b[a]=this[a]},this);this.dStack.push(b);this.mStack.push(this.m)},restore:function(){var b=this.dStack.pop();this.states.each(function(a){this[a]=b[a]},this);this.m=this.mStack.pop()},mStack:[],dStack:[]});
CanvasRenderingContext2D.implement({createLinearGradient:function(b,a,c,d){return new CanvasGradient(b,a,c,d,this)},createRadialGradient:function(b,a,c,d,e,g){return Object.append(new CanvasGradient(b,a,d,e,this),{r0:c,r1:g})}});
CanvasGradient=new Class({initialize:function(b,a,c,d,e){this.angle=((d-a)/((c-b).pow(2)+(d-a).pow(2)).sqrt()).acos();this.ctx=e},addColorStop:function(b,a){a=this.processColor(a);1==b||0==b?this["col"+b]=a:(this.stops||(this.stops=[]),this.stops.push([b,a.color]))},processColor:function(b){var a=this.ctx.globalAlpha||1;"rgb"==b.substr(0,3)&&("a"==b.charAt(3)&&(a*=b.match(/([\d.]*)\)$/)[1]),b=b.rgbToHex());return{color:b,opacity:a}}});
CanvasRenderingContext2D.implement({createPattern:function(b,a){return new CanvasPattern(b,a)}});CanvasPattern=new Class({initialize:function(b,a){this.img=b;this.rep=a}});window.addEvent("domready",function(){MediaManager.initialize()});
MediaManager=function(){function b(a,b,c,e,n){if("select"!==a)return!0;var l=this;n.attachItem(e,function(a,b,c){if(!b)return c&&MediaLibrary.appendAlertMessage(c),l.transition.cancel();a&&delete d[a.getGlobalID()];e.whenReady(function(){d[e.getGlobalID()]=!0});l.transition()});return StateMachine.ASYNC}function a(){c=new MediaItemMenu;c.menuItems.addEvents({markers:function(a){Auth.required({onAuthorize:function(){ImageMarkers.showForMediaItem(a)}})},crop:function(a){Auth.required({onAuthorize:function(){var b=
a.getContext(),c=null;b==MediaLibrary?c=MediaLibrary.mediaTarget:instanceOf(b,MediaTarget)&&(c=b);ImageCrop.showForMediaItem(a,c)}})},deleted:function(a){e.detach(a)},fullsize:function(a){a=a.data.standard().replace(/\.standard$/,"");window.open(a)},copy:function(a){Auth.required({onAuthorize:a.copyToMediaLibrary.bind(a)})}})}var c,d={};MediaItem.addEvent("toggleMenu",function(a,b){c.toggleForMediaItem(a,b)});var e={mediaTarget:null,initialize:function(){MediaTarget.registerAllTargets();a()},detach:function(a){Auth.required({onAuthorize:function(){delete d[a.getGlobalID()];
a.deleted()}})},onenterchoosing:function(a,b,c,e){function n(a){if(!a)return MediaManager.cancel();var b=a.data.filter_state();switch(b){case "crop":MediaManager.crop(a,e);break;case !0:case !1:MediaManager.select(a,e);break;default:b&&MediaLibrary.appendAlertMessage(b.message)}}"hidden"==b&&MediaLibrary.showForTarget(e,n,d)},oncrop:function(a,b,c,d,e){ImageCrop.showForMediaItem(d,e,function(a){a?(MediaManager.select(a,e),Modal.pop()):MediaManager.cancelCrop()})},onleavechoosing:b,onleavecropping:b,
onenterhidden:function(){Modal.pop()}};return e}();StateMachine.create({target:MediaManager,initial:"hidden",events:[{name:"cancel",from:"*",to:"hidden"},{name:"cancelCrop",from:"cropping",to:"choosing"},{name:"browse",from:"hidden",to:"choosing"},{name:"crop",from:"choosing",to:"cropping"},{name:"select",from:["choosing","cropping"],to:"hidden"}]});
MediaItemMenu=new Class({Implements:[Options,Events],options:{tooltip:{autohide:!0,hideDelay:700,side:"top",arrowAlign:"right",arrowInset:10,nudge:-19,zIndex:1000100}},initialize:function(){this.sides={};this.items={};this.isOpen=!1;this.menuItems=new Events;this.menu=(new Element("div.mediaItemMenu",{events:{mousedown:function(b){b.stop()}}})).adopt(this.sides.left=new Element("ul.left"),this.sides.right=new Element("ul.right"),this.sides.bottom=new Element("div.bottom.clearer"));this.tooltip=new Tooltip(null,
this.options.tooltip);this.addMenuItems()},addMenuItems:function(){var b={fullsize:{side:"left",text:_js("Full Size"),icon:"iconFullsize"},deleted:{side:"right",text:_js("Delete"),icon:"iconDelete"},copy:{side:"right",text:_js("Copy"),icon:"iconCopy",hoverText:_js("Copy to Media Manager")}};mobileDetected()||tabletDetected()||(b.markers={side:"left",text:_js("Markers..."),icon:"iconMarkers"},b.crop={side:"left",text:_js("Crop..."),icon:"iconCrop"});Object.each(b,function(a,b){this.addItem(b,a)},this)},
addItem:function(b,a){var c=this,d,e=(new Element("li",{events:{mouseenter:this.hoverItem.bind(this,b),mouseleave:this.blurItem.bind(this,b),click:function(d){d.stop();if(!this.hasClass("inactive")){c.menuItems.fireEvent(b,[c.mediaItem]);if(a.onSelect)a.onSelect();c._close()}}}})).adopt(new Element("div.icon."+a.icon),d=new Element("a",{text:a.text,events:{click:function(a){a.preventDefault()}}}));a.hoverText&&(e.tooltip=new Tooltip(e,{autoshow:!0,text:a.hoverText,hideDelay:0,zIndex:this.options.tooltip.zIndex+
1}),e.addEvent("click",e.tooltip.hide.bind(e.tooltip)));e.inject(this.sides[a.side]);e.store("link",d);this.items[b]=e;return this},disableItem:function(b){this.items[b].addClass("inactive");return this},enableItem:function(b){this.items[b].removeClass("inactive");return this},toggleForMediaItem:function(b,a){if(this.tooltip.visible()&&b==this.mediaItem)this._close();else{this.tooltip.visible()&&this.tooltip.hide();this.mediaItem=b;var c=b.collectMenuOptions();Object.each(this.items,function(a,b){var g=
c[b],f="string"==typeOf(g),h=a.retrieve("link");a.toggle(g);a.toggleClass("inactive",f);h.set("title",f?g:"")});this._openAtAnchor(a)}},_close:function(){this.tooltip.hide();return this},_openAtAnchor:function(b){b&&this.tooltip.setAnchor(b);this.tooltip.set(this.menu).show();return this},_hideItem:function(b){this.items[b].hide();return this},_showItem:function(b){this.items[b].show();return this},hoverItem:function(b){b=this.items[b];b.hasClass("inactive")||b.addClass("active")},blurItem:function(b){this.items[b].removeClass("active")},
selectItem:function(b,a){this.items[b].hasClass("inactive")||!1!==a()&&this.close()}});
MediaItemImage=new Class({Extends:MediaItem,hasMarkers:function(){var b=this.data.markup();return b&&b.draw},hasCrop:function(){var b=this.data.markup();return b&&b.crop},cropMarkupString:function(){return this.hasCrop()?this.data.markup_string().split(";")[1]:""},markersString:function(){var b=this.data.markup_string();return this.hasCrop()?b.split(";").slice(2).join(";"):b},_getMenuOptions:function(){var b=this.data.filter_state(),a=!0;this.getContext()===MediaLibrary&&"object"==typeOf(b)&&(a=b&&
b.message);return{markers:!0,crop:a,fullsize:!0}},createRepresentationFor:function(b,a){var c=b.options.displaySize,d=this;d.whenReady(function(){var b=new MediaItemImageDisplay(d,{size:c,useBackground:!1});b.whenReady(function(){a(b)})})},createDisplay:function(b,a){return new MediaItemImageDisplay(this,{size:this.getLargestImageSize(b),useBackground:!1,showFilename:a})},getSrc:function(b){return this.data[b]()},getUncroppedPreview:function(b){return this.data.markup_string()?"/Guide/image/preview/"+
this.data.srcid()+"/"+this.markersString()+"/"+b:this.getSrc(b)},getID:function(){return this.data.imageid()},getEncoding:function(){return this.data.encoding()},getType:function(){return this.data.type()},getFilter:function(){return"onlyImages"},toWikiText:function(){return"undefined"!==typeof App.wikiTitle?"[image|"+this.getID()+"|align=left]":"[image|"+this.getID()+"]"},getGlobalID:function(){return"image:"+this.getID()}});MediaItem.registerType("GuideImage",MediaItemImage);
MediaItem.registerType("CartImage",MediaItemImage);
function MediaItemImageDisplay(b,a){a=a||{};var c=a.classOverride||"mediaImage",d=this;this.size=a.size||"standard";this.displayType=a.useBackground?"background":"img";this.mediaItem=b;c=this.container=new Element("div.mediaItem."+c+'[data-imageid="'+b.getID()+'"]');!1!==a.menu&&c.adopt(MediaItem.createMenuControl(b));if(a.showFilename){var e=new Element("span.file-container"),g=new Element("div.filetypeContainer");this.filename=new Element("p.filename");this.filetype=new Element("div.filetype");
var f=new Element("i.fileicon.fa.fa-picture-o");this._updateFilename();e.grab(this.filename);c.grab(g);c.grab(e);c.grab(this.filetype);c.grab(f)}c.addEvent("click",this.fireEvent.pass(["select",b],this));this.container.store("mediaItem",b);b.addEvents({dataChanged:this._updateDisplay.bind(this),loadingChanged:this._updateLoading.bind(this),deleted:this.dispose.bind(this)});b.isReady()?d._updateDisplay():d._updateLoading(!0)}
Object.append(MediaItemImageDisplay.prototype,{getElement:function(){return this.container},whenReady:function(b){if(this._elementPromise)return this._elementPromise.getValue(b);b&&b();return!0},_updateDisplay:function(){var b=this,a=this.mediaItem.getSrc(b.size),c=this._elementPromise=new Future;new Asset.image(a,{onLoad:function(){if("background"==b.displayType){var d=b._displayElement=new Element("div.contents."+b.size);d.setStyle("backgroundImage","url("+a+")");b.container.grab(d)}else d=b._displayElement,
d||(d=b._displayElement=new Element("img."+b.size),b.container.grab(d)),d.set("src",a);b._updateFilename();(function(){c.resolve(a)}).delay(10)}})},_updateFilename:function(){if(this.filename){var b=this.mediaItem,a=b.data.filename();a&&(this.filename.setProperties({text:a.substr(0,a.lastIndexOf(".")),title:b.data.filename()}),this.filetype.setProperties({text:a.substr(a.lastIndexOf(".")+1).toUpperCase()}),this.filename.toggle(b.data.filename()))}},_updateLoading:function(b){var a=this._overlay();
b?this.container.grab(a):this.whenReady(function(){a.dispose()});this._updateFilename()},dispose:function(){this.container.dispose();this.filename&&this.filename.dispose();this.removeEvents()},_overlay:function(){return this._overlayEl=this._overlayEl||new Element("div.loadingOverlay")},inject:function(b,a){return this.container.inject(b,a||"after")},hide:function(){return this.container.hide()},show:function(){return this.container.show()}});Object.append(MediaItemImageDisplay.prototype,Utils.EventsFunctions);
MediaItemDocument=new Class({Extends:MediaItem,_getMenuOptions:function(){return{}},createRepresentationFor:function(b,a){var c=b.options.displaySize,d=this;d.whenReady(function(){var b=d.createDisplay(c,!1);b.whenReady(function(){a(b)})})},createDisplay:function(b,a){b=this.getLargestImageSize(b);return new MediaItemImageDisplay(this,{size:b,useBackground:!0,showFilename:a,classOverride:"mediaDocument"})},getID:function(){return this.data.documentid()},getFilename:function(){return this.data.filename()},
getTitle:function(){return this.data.title()},getType:function(){return this.data.type()},getFilter:function(){return"onlyDocuments"},getSrc:function(b){return this.data[b]()},getViewUrl:function(){return this.data.view_url()},toWikiText:function(){return"[document|"+this.getID()+"]"},getGlobalID:function(){return"document:"+this.getID()}});MediaItem.registerType("Document",MediaItemDocument);
VideoEncodings={MP4_720:{column:"MP4_720",label:"Medium",encoding:"mp4",width:720,height:480,codecs:"avc1.42E01E, mp4a.40.2",mime:"video/mp4",always_generate:!0},MP4_592:{column:"MP4_592",label:"Low",encoding:"mp4",width:592,height:444,max_video_bitrate:1500,codecs:"avc1.42E01E, mp4a.40.2",mime:"video/mp4",always_generate:!0},WEBM:{column:"WEBM",label:"Low",encoding:"webm",width:592,height:444,codecs:"vp8, vorbis",mime:"video/webm",always_generate:!0},OGG:{column:"OGG",label:"Low",encoding:"ogg",
width:592,height:444,codecs:"theora, vorbis",mime:"video/ogg",always_generate:!0},MP4_1920:{column:"MP4_1920",label:"1080p",encoding:"mp4",width:1920,height:1080,codecs:"avc1.42E01E, mp4a.40.2",mime:"video/mp4",always_generate:!1},MP4_1280:{column:"MP4_1280",label:"720p",encoding:"mp4",width:1280,height:720,codecs:"avc1.42E01E, mp4a.40.2",mime:"video/mp4",always_generate:!1}};
MediaItemVideo=new Class({Extends:MediaItemImage,_getMenuOptions:function(){return{}},createRepresentationFor:function(b,a){var c=b.options.displaySize,d=this;d.whenReady(function(){var b=d.createDisplay(c,!1);b.whenReady(function(){a(b)})})},createDisplay:function(b,a){b=this.getLargestImageSize(b)||"standard";return"thumbnail"==b?new MediaItemImageDisplay(this,{size:b,useBackground:!0,showFilename:a,classOverride:"mediaVideo"}):new MediaItemVideoDisplay(this,{size:b,showFilename:a})},getID:function(){return this.data.objectid()},
getType:function(){return this.data.type()},getFilter:function(){return"onlyObjects"},toWikiText:function(){return"[video|"+this.data.videoid()+"]"},getGlobalID:function(){return"video:"+this.getID()}});MediaItem.registerType("GuideVideoObject",MediaItemVideo);
function MediaItemVideoDisplay(b,a){a=a||{};var c=this;c.size=a.size;this.mediaItem=b;this._elementPromise=new Future;this._small=!MediaItem.isSizeAsBigAs(a.size,"medium");var d=this.container=new Element("div.mediaItem.mediaObject");d.adopt(MediaItem.createMenuControl(b));this._small&&d.addEvent("click",this.fireEvent.pass(["select",b],this));if(a.showFilename){var e=new Element("span.file-container"),g=new Element("div.filetypeContainer");this.filename=new Element("p.filename");this.filetype=new Element("div.filetype");
var f=new Element("i.fileicon.fa.fa-video-camera");this._updateFilename();e.grab(this.filename);d.grab(g);d.grab(e);d.grab(this.filetype);d.grab(f)}this.container.store("mediaItem",b);b.addEvents({dataChanged:this._updateDisplay.bind(this),loadingChanged:this._updateLoading.bind(this),deleted:this.dispose.bind(this)});b.isReady()?c._updateDisplay():c._updateLoading(!0)}Object.append(MediaItemVideoDisplay.prototype,MediaItemImageDisplay.prototype);
Object.append(MediaItemVideoDisplay.prototype,{_updateDisplay:function(){if(this._small)this._updateImageDisplay();else{var b=this,a=Utils.createElements({tag:"video",c:"video-js vjs-default-skin",children:this._createSourceElements()});if(!b._elementPromise||b._video)b._elementPromise=new Future;b.container.grab(a);videojs(a,{controls:!0,autoplay:!1,preload:"auto"},function(){b._elementPromise.resolve(a)});b._video=a}},_createSourceElements:function(){var b=this.mediaItem.data.video_urls(),a=Utils.createElements,
c=[];Object.each(b,function(b,e){var g=VideoEncodings[e.toUpperCase()];c.push(a({tag:"source",src:b,codecs:g.codecs,type:g.mime}))});return c},_updateImageDisplay:function(){var b=this,a=this.mediaItem.getSrc(b.size);if(!b._elementPromise||b._displayElement)b._elementPromise=new Future;var c=b._displayElement;c||(c=b._displayElement=new Element("img."+b.size),b.container.grab(c));c.set("src",a);(function(){b._elementPromise.resolve(a)}).delay(10)},_updateLoading:function(b){}});
MediaItemEmbed=new Class({Extends:MediaItem,_getMenuOptions:function(){return{}},createRepresentationFor:function(b,a){var c=b.options.displaySize,d=this;d.whenReady(function(){var b=d.createDisplay(c,!1);a(b)})},createDisplay:function(b,a){b=this.getLargestImageSize(b)||"standard";return new MediaItemEmbedDisplay(this,{size:b,showFilename:a})},getID:function(){return this.data.objectid()},getSrc:function(b){return this.data[b]()},getType:function(){return this.data.type()},getFilter:function(){return"onlyObjects"},
toWikiText:function(){return"[embed|"+this.data.view_url()+"]"},getGlobalID:function(){return"embed:"+this.getID()}});MediaItem.registerType("GuideEmbedObject",MediaItemEmbed);
function MediaItemEmbedDisplay(b,a){a=a||{};var c=this;c.size=a.size;this.mediaItem=b;this._elementPromise=new Future;this._small=!MediaItem.isSizeAsBigAs(a.size,"medium");var d=this.container=new Element("div.mediaItem.mediaObject");d.adopt(MediaItem.createMenuControl(b));this._small&&d.addEvent("click",this.fireEvent.pass(["select",b],this));d.store("mediaItem",b);if(a.showFilename){var e=new Element("span.file-container"),g=new Element("div.filetypeContainer");this.filename=new Element("p.filename");
this.filetype=new Element("div.filetype");var f=new Element("i.fileicon.fa.fa-youtube-play");this._updateFilename();e.grab(this.filename);d.grab(g);d.grab(e);d.grab(this.filetype);d.grab(f)}b.addEvents({dataChanged:this._updateDisplay.bind(this),loadingChanged:this._updateLoading.bind(this),deleted:this.dispose.bind(this)});b.isReady()?c._updateDisplay():c._updateLoading(!0)}
Object.append(MediaItemEmbedDisplay.prototype,{getElement:function(){return this.container},whenReady:function(b){if(this._elementPromise)return this._elementPromise.getValue(b);b&&b();return!0},_updateDisplay:function(){this.size=this.mediaItem.getLargestImageSize(this.size);this._small?this._updateImageDisplay():this.container.appendHTML(this.mediaItem.data.html())},_updateImageDisplay:function(){var b=this,a=this.mediaItem.getSrc(b.size);if(!b._elementPromise||b._displayElement)b._elementPromise=
new Future;var c=b._displayElement;c||(c=b._displayElement=new Element("img."+b.size),b.container.grab(c));c.set("src",a);(function(){b._elementPromise.resolve(a)}).delay(10)},_updateFilename:function(){if(this.filename){var b=this.mediaItem.data.filename();this.filename.setProperties({text:b,title:b});this.filetype.setProperties({text:this.mediaItem.data.provider().toUpperCase()});this.filename.toggle(b)}},_updateLoading:function(b){var a=this._overlay();b?this.container.grab(a):this.whenReady(function(){a.dispose()})},
dispose:function(){this.container.dispose();this.removeEvents()},_overlay:function(){return this._overlayEl=this._overlayEl||new Element("div.loadingOverlay")},inject:function(b,a){return this.container.inject(b,a||"after")},hide:function(){return this.container.hide()},show:function(){return this.container.show()}});Object.append(MediaItemEmbedDisplay.prototype,Utils.EventsFunctions);
FrameModules.add("WikiImageFrameModule",function(){when($("pageImages"),function(b){WikiImageManager.initialize();["wikiSummaryImage","wikiBannerImageContainer"].each(function(a){(a=$(a))&&MediaTarget.createFromElement(a).addEvent("itemChanged",function(a,b){a&&WikiImageManager.addImage(a,b)})})})});
WikiImageManager={initialize:function(){var b=this;this.thumbsContainer=$("pageImages");this.imageMeta=$$(".imageMeta");var a;(a=$("wikiid").get("text"))&&(new Request.AjaxIO("getWikiImages",{onSuccess:function(a){a.map(function(a){a=MediaItem.createFromData(a);b.addImage(a)})}})).send(a)},addImage:function(b,a){a&&this.removeImage(a);var c=(new MediaItemImageDisplay(b,{size:"thumbnail",useBackground:!1,showFilename:!1,menu:!1})).getElement();this.thumbsContainer.grab(c);var d,e=this.imageMeta.getFirst();
c.addEvent("mouseenter",function(a){clearTimeout(d);e.set("text",b.getGlobalID());d=e.makeInvisible.delay(5E3,e)});this.imageMeta.addEvents({mouseenter:function(a){clearTimeout(d);e.makeVisible()},mouseleave:function(a){d=e.makeInvisible.delay(5E3,e)}})},removeImage:function(b){return $$('#pageImages .mediaItem[data-imageid="'+b.getID()+'"]').dispose()}};FrameModules.add("WikiRelatedFrameModule",function(){WikiRelatedFrameModule.initialize()});
WikiRelatedFrameModule={initialize:function(){when($("wikiRelatedInput"),function(b){DeviceFinder.initialize(b)})}};FrameModules.add("WikiHelpSidebarFrameModule",function(){var b=$("wikiHelpSidebar"),a,c=b.getElements("a[href$='"+window.location.pathname+"']")[0];c&&(a=c.getParent(".subSection ul"));new Fx.Accordion(b,".subSection",".subSection ul",{duration:250,display:a,initialDisplayFx:!1,onActive:function(a){a.addClass("highlight")},onBackground:function(a){a.removeClass("highlight")}})});
FrameModules.add("UserLikeFrameModule",function(){document.getElements(".js-favorite").each(function(b){new LikeMeControl(b)})});
LikeMeControl=new Class({el:null,count:null,doctype:null,docid:null,action:null,requesting:!1,likedClass:"fa-heart",unlikedClass:"fa-heart-o",initialize:function(b){this.el=b;this.control=b.hasClass("control")?b:b.getElement(".control");this.useTooltip="true"==b.getProperty("data-useTooltip");this.iconEl=b.getElement(".js-icon-el");this.countEl=b.getElement(".likeCount")||$$(".js-like-count");this.textEl=b.getElement(".likeText");this.doctype=b.get("data-doctype");this.docid=b.get("data-docid");this.likedText=
this.control.getProperty("data-likedText");this.unlikedText=this.control.getProperty("data-unlikedText");this.likedClass=this.control.getProperty("data-likedIcon")||this.likedClass;this.unlikedClass=this.control.getProperty("data-unlikedIcon")||this.unlikedClass;this.likeInfo=App.userLikeInfo[this.doctype+"_"+this.docid];void 0!==this.likeInfo?this.initializeInterface():(new Request.AjaxIO("ajaxDoesLike",{onSuccess:function(a){this.likeInfo=a;this.initializeInterface()}.bind(this)})).send(this.doctype,
this.docid);this.control.addEvents({mouseenter:this.entered.bind(this),mouseleave:this.left.bind(this),click:function(a){a.stop();this.clicked()}.bind(this)})},initializeInterface:function(){this.useTooltip&&Tooltip.instance(this.control,{side:"top",align:"left",autoshow:!0});this.count=this.likeInfo.count;this.countEl&&this.countEl.set("text",this.count);this.likeInfo.likes?this.setLiked():this.likeInfo.notLoggedIn?this.setNoUpdate():this.setUnliked();this.el.makeVisible()},entered:function(){this.likeInfo.likes||
this.iconEl.removeClass(this.unlikedClass).addClass(this.likedClass)},left:function(){this.likeInfo.likes||this.iconEl.removeClass(this.likedClass).addClass(this.unlikedClass)},clicked:function(){this.favorite()},favorite:function(){this.requesting||Auth.required({message:_js('Log in to "favorite" this.'),onAuthorize:function(){this.useTooltip?Tooltip.instance(this.control,_js("Updating...")).show():this.iconEl.set("class","fa fa-spinner fa-spin js-icon-el");this.requesting=!0;var b;"like"===this.action?
b="PUT":"unlike"===this.action&&(b="DELETE");(new Request.API_2_0("user/favorites/guides/"+this.docid,{method:b,onSuccess:function(a){a="like"===this.action;this.likeInfo.likes=a;this.iconEl.set("class","fa js-icon-el");a?(this.count+=1,this.setLiked()):(--this.count,this.setUnliked());this.requesting=!1}.bind(this),onFailure:function(a,b){Modal.alert(b)}})).send({langid:App.langid})}.bind(this)})},setLiked:function(){this.useTooltip?Tooltip.instance(this.control,this.likedText):this.textEl.set("text",
this.likedText);this.countEl&&this.countEl.set("text",this.count);this.action="unlike";this.iconEl.removeClass(this.unlikedClass).addClass(this.likedClass)},setUnliked:function(){this.useTooltip?Tooltip.instance(this.control,this.unlikedText):this.textEl.set("text",this.unlikedText);this.countEl&&this.countEl.set("text",this.count);this.action="like";this.iconEl.removeClass(this.likedClass).addClass(this.unlikedClass)},setNoUpdate:function(){this.useTooltip&&Tooltip.instance(this.control,this.unlikedText);
this.el.addClass("noUser")}});FrameModules.add("UserFlagsFrameModule",function(){(function(){$$(".setUserFlagLink").each(function(b){var a=b.get("data-contentKey"),c=b.get("data-contentId");b.addEvent("click",function(b){b.stop();null!==c&&TweenMax.to($(c),.5,{height:0,overflow:"hidden"});(new Request.AjaxIO("setFlag",{onSuccess:function(a){a.success||alert(a.error)}})).send(a)})})})()});
FrameModules.add("UserFeedbackFrameModule",function(){$$(".user_feedback_vote_button").addEvent("click",function(b){var a=this;if(!a.hasClass("disabled")){b=a.get("data-url");var c={doctype:a.get("data-doctype"),docid:a.get("data-docid"),score:a.get("data-score")},d=a.get("data-scoreid"),e=(d=d?$(d):null)?parseInt(d.get("html"),10):0,g=parseInt(c.score,10),f;f=a.hasClass("down")?a.getParent().getChildren(".up")[0]:a.getParent().getChildren(".down")[0];if(a.hasClass("active"))e-=g,a.removeClass("active");
else if(f.hasClass("active")){var h=parseInt(f.get("data-score"),10),e=e+g-h;a.addClass("active");f.removeClass("active")}else e+=g,a.addClass("active");a.addClass("disabled");f.addClass("disabled");a.addClass("inProgress");null!=d&&d.set("html",e);when($("user_feedback_text_dropdown"),function(b){var c=b.get("data-url"),d={doctype:a.get("data-doctype"),docid:a.get("data-docid")};b.hasClass("hidden")&&(b.slide("hide"),b.removeClass("hidden"),b.set("slide",{duration:250}));b.slide("in");var f=b.getElement("textarea"),
e=f.get("maxlength").toInt(),g=b.getElement(".user_feedback_text_remaining_chars");f.addEvent("keyup",function(){var a=this.get("value"),b=e-a.length;0>b&&(a=a.substr(0,e),b=0,f.set("value",a));g.set("text",b)});$$(".user_feedback_send_button").removeEvents().addEvent("click",function(a){a.stop();a=f.get("value");d.text=a;b.slide("out");(new Request.API_2_0(c,{method:"post",onSuccess:function(a){}})).send(d)})});(new Request.API_2_0(b,{method:"post",onSuccess:function(b){"anonymous"!=b.voteType?(a.removeClass("disabled"),
f.removeClass("disabled")):(a.addClass("hidden"),f.addClass("hidden"),a.getNext(".user_feedback_vote_thanks_text").removeClass("hidden"));a.removeClass("inProgress")}})).send(c)}})});
FrameModules.add("TeamProfileFrameModule",function(){TeamProfileBox.initialize();$$(".repairServicesShowMore").addEvent("click",function(a){a.stop();$("repairServices").toggle()});if(App.showStatus){var b=new StatusNotice;$("inviteStatus").adopt(b.element).inject($("bodyTop"),"top");App.success?b.good(_js("You have been added to this team!")):b.error(_js("There was an error adding you to this team"))}App.promptLogin&&(App.hasUser?Auth.login({from:"navLogin",message:_js("Logging in will reload the page."),
reload:!Utils.hasUnsavedChanges()}):Auth.login({from:"navSignup",message:_js("Registering will reload the page."),reload:!0,register:!0}));trackLink($$(".teamBookingLink"),"Lead Generation","Team Booking Click",App.businessName);$("inviteContainer")&&new InviteForm});
InviteForm=new Class({Implements:Options,options:{popFx:{duration:200,transition:"quad:out"}},initialize:function(b){this.setOptions(b);this.inviteContainer=$("inviteContainer");this.modalLink=$("modalLink");this.container=$("inviteContainer");this.userList=$("userListContainer");this.forceInvites=$("forceInvites");this.emails=$("inviteEmails");this.message=$("inviteMessage");this.submitButton=$("inviteSubmit");this.closeButton=$("inviteClose");this.emailsHelp=$("inviteEmailsHelp");this.invalidEmails=
$("inviteInvalidEmails");this.noticeDiv=$("statusNoticeDiv");this.modalLink.addEvent("click",function(a){a.stop();this.emails.addEvent("focus",function(a){this.emailsHelp.show();this.invalidEmails.hide()}.bind(this));this.setupNotice("title");Modal.open({type:"element",element:this.inviteContainer});this.inviteContainer.show()}.bind(this));this.submitButton.addEvent("click",function(a){a=this.matchEmails();if(!(0>=a.length)){var b=this.inviteContainer.get("data-teamid"),d=this.message.get("value"),
e=this.forceInvites?this.forceInvites.get("checked"):!1;this.processInvites(b,a,d,e)}}.bind(this));this.closeButton.addEvent("click",function(a){Modal.close()}.bind(this))},matchEmails:function(){var b=this.emails.get("value").match(/([a-z0-9._-]+@[a-z0-9._-]+\.[a-z]{2,4})/gi);if(!b)return this.invalidEmailsError(),[];for(var a=[],c=0;c<b.length;c++)a.contains(b[c])||a.push(b[c]);return a},invalidEmailsError:function(){this.emailsHelp.hide();this.invalidEmails.show();this.emails.setStyle("border-color",
"#8a1c1c");this.emails.setStyle("background","#efd0d0")},setupNotice:function(b){var a=new StatusNotice;this.noticeDiv.empty();this.noticeDiv.adopt(a.element);switch(b){case "error":a.error(_js("Remaining emails are either invalid or already in team."));break;case "serious_error":a.error(_js("Operation Failed"));break;case "send":a.notice(_js("Sending Invites..."));break;default:a.good(App.title)}},processInvites:function(b,a,c,d){this.lockForm();this.setupNotice("send");(new Request.AjaxIO("sendInvites",
{onSuccess:function(a){a?(this.setupNotice("error"),this.unlockForm(),this.emails.set("value",a)):(Modal.close(),this.resetForm(),StatusPanel.notify(_js("Invites sent!"),2,{reload:!1}))}.bind(this),onError:function(a){this.setupNotice("serious_error");this.unlockForm()}.bind(this)})).send(b,a,c,d)},resetForm:function(){this.unlockForm();this.emailsHelp.show();this.invalidEmails.hide();this.message.set("value","")},lockForm:function(){this.emails.disabled=!0;this.message.disabled=!0;null!==this.forceInvites&&
(this.forceInvites.disabled=!0);this.submitButton.disabled=!0;this.submitButton.addClass("buttonLinkDisabled");this.closeButton.disabled=!0;this.closeButton.addClass("buttonLinkDisabled")},unlockForm:function(){this.emails.disabled=!1;this.message.disabled=!1;null!==this.forceInvites&&(this.forceInvites.disabled=!1);this.submitButton.disabled=!1;this.submitButton.removeClass("buttonLinkDisabled");this.closeButton.disabled=!1;this.closeButton.removeClass("buttonLinkDisabled")}});
TeamProfileBox={initialize:function(){when($("reqLogin"),this.requireLogin);this.leaveTeam();this.joinTeam()},requireLogin:function(b){Auth.login({from:"navLogin",message:_js("Logging in will reload the page."),reload:!0})},leaveTeam:function(){$$(".leaveTeam").addEvent("click",function(b){b.stop();b=this.get("data-memberCount");this.get("data-teamid");(1==b?confirm("Warning! You are the last member of this team. Leaving this team will delete the team. Do you want to continue?"):confirm("Warning! Leaving this team will remove all of your contributions and activities from your team's history. Do you want to continue?"))&&
(new Request.API_2_0(App.teamApi.leaveUrl+App.userid,{method:App.teamApi.leaveMethod,statusPanelMessage:_js("Leaving..."),onSuccess:function(a){window.location.search=""},onFailure:function(a,b){alert(b)}})).send()})},joinTeam:function(){$$(".joinTeam").addEvent("click",function(b){b.stop();var a=this;Auth.required({reload:!1,message:_js("Log in to join this team."),onAuthorize:function(b){b=b&&b.userid?b.userid:App.userid;var d=a.get("data-joinCode");(new Request.API_2_0(App.teamApi.joinUrl+b+(d?
"?join_code="+d:""),{method:App.teamApi.joinMethod,statusPanelMessage:_js("Joining..."),onSuccess:function(a){window.location.reload()},onFailure:function(a,b){alert(b)}})).send()}})})}};
FrameModules.add("AuthorEditFrameModule",function(){window.AuthorEditor={options:{max:999,hideOnMax:!0,controls:!0,form:$("author-edit-form"),formManager:null,input:$("author-input"),inputContainer:$("author-input-container"),container:$("author-name-container"),cancelControl:$("cancel-author-change"),control:$("edit-author-button"),customChoicesContainer:$("author-search-choices"),multiple:!1,overflow:!0,currentAuthorName:$("current-author-name"),currentAuthorImage:$("current-author-image")},initialize:function(b){this.setOptions(b);
this.form=this.options.form;this.container=this.options.container;this.control=this.options.control;this.cancelControl=this.options.cancelControl;this.input=this.options.input;this.inputContainer=this.options.inputContainer;this.customChoicesContainer=this.options.customChoicesContainer;this.docid=this.form.guideid.value;this.langid=this.form.langid.value;this.currentAuthorName=this.options.currentAuthorName;this.currentAuthorImage=this.options.currentAuthorImage;b=App.authorInfo.username;App.authorInfo.unique_username&&
(b+=" (@"+App.authorInfo.unique_username+")");this.currentAuthorInfo={name:b,image:App.authorInfo.image};this.newAuthorInfo={};var a=function(a){a&&a.stop();this.input.set("value","");this.inputContainer.show();this.input.focus();this.newAuthorInfo={};this.input.addEvent("blur",function(a){a.stop();this.currentAuthorName.set("text",this.newAuthorInfo.name?this.newAuthorInfo.name:this.currentAuthorInfo.name);this.currentAuthorImage.set("src",this.newAuthorInfo.image?this.newAuthorInfo.image:this.currentAuthorInfo.image);
this.inputContainer.hide()}.bind(this))}.bind(this);this.control.addEvent("click",a);new SuggestAuthors(this.options.input,{customChoices:this.customChoicesContainer,maxChoices:5,multiple:!1,onSelect:function(a,b,e){this.currentAuthorName.set("text",b.get("data-username"));this.currentAuthorImage.set("src",b.get("data-image"))}.bind(this),onSelection:function(b,d,e){this.newAuthorInfo={userid:b.get("data-userid"),name:b.get("data-username"),image:b.get("data-image")};this.control.innerHTML=_js("Save");
this.control.removeEvents();this.control.addEvent("click",function(b){this.saveAuthor();this.cancelControl.hide();this.control.removeEvents();this.control.innerHTML=_js("Edit");this.control.addEvent("click",a)}.bind(this));this.cancelControl.addEvent("click",function(b){this.cancelControl.hide();this.currentAuthorName.set("text",this.currentAuthorInfo.name);this.currentAuthorImage.set("src",this.currentAuthorInfo.image);this.control.innerHTML=_js("Edit");this.control.removeEvents();this.control.addEvent("click",
a)}.bind(this));this.cancelControl.show("inline-block");this.inputContainer.hide()}.bind(this),relative:!0});return this},saveAuthor:function(){(new Request.AjaxIO("saveAuthor",{onSuccess:function(b){b.error?Modal.alert(b.error):(this.control.innerHTML=_js("Edit"),this.currentAuthorInfo.name=b.username,b.unique_username&&(this.currentAuthorInfo.name+=" (@"+b.unique_username+")"),this.currentAuthorInfo.image=b.image)}.bind(this)})).send(this.newAuthorInfo.userid,this.docid,this.langid)}};Object.append(AuthorEditor,
Utils.EventsFunctions);Object.append(AuthorEditor,new Options)});
FrameModules.add("TagsEditFrameModule",function(){window.TagEditor={options:{max:999,hideOnMax:!0,controls:!0,form:$("tagsEditForm"),formManager:null,input:$("tagsEdit"),container:$("tagList"),control:$E(".saveTagsControl")},initialize:function(b){this.setOptions(b);this.form=this.options.form;this.container=this.options.container;this.docid=this.form.docid.value;this.doctype=this.form.doctype.value;this.input=this.options.input;this.options.formManager||new FormManager(this.form);this.tags=[];var a=
function(a){a&&a.stop();this.submitTags()}.bind(this);$("tagsAdd").addEvent("click",a);new SuggestTags(this.options.input,{onSelection:function(){a(null)}});this.container.getChildren().each(function(a){"none"==a.getStyle("display")?a.dispose():this.setup(a,!0)}.bind(this));if(this.control=this.options.control)this.control.getElement("a[href$=save-tags]").addEvent("click",this.save.bind(this)),this.control.getElement("a[href$=cancel-tags]").addEvent("click",this.cancel.bind(this));this.savedTags=
[].append(this.tags);this.fireEvent("change",[this.tags]);return this},save:function(b,a){b.stop();(new Request.AjaxIO("saveTags",{onSuccess:function(b){a&&a();if(b.error)Modal.alert(b.error);else{var d=b.tags;when($("revisionid"),function(a){null!=b.revisionid&&a.set("value",b.revisionid)});this.tags=[];this.container.empty();d.each(function(a){this.addTag(a,!0)}.bind(this));this.savedTags=[].append(this.tags);this.control.hide();this.fireEvent("change",[this.tags]);this.fireEvent("done")}}.bind(this)})).send(this.docid,
this.doctype,this.tags)},cancel:function(b){b.stop();this.tags=[];this.container.empty();this.savedTags.each(function(a){this.addTag(a,!0)}.bind(this));this.control.hide();this.checkMax();this.fireEvent("change",[this.tags]);this.fireEvent("done")},isLegacyTagStyle:function(){return this.container.hasClass("legacyTagStyle")},addTag:function(b,a){if(!this.tags.contains(b)&&!this.tags.contains("#"+b)){var c=new Element("li",{"class":"js-tag","data-tag":b});this.isLegacyTagStyle()?c=(new Element("li")).set("text",
b):(c.adopt(new Element("i",{"class":"fa fa-circle-o"})),c.adopt(new Element("i",{"class":"fa fa-times js-tag-delete",style:"display: none"})),c.adopt(new Element("span",{text:b})));c.inject(this.container);this.container.show();this.setup(c,a);this.showControls()}},submitTags:function(){(new Request.AjaxIO("addTags",{onSuccess:function(b){b.each(function(a){var b=this.tags.length;++b<=this.options.max?this.addTag(a):(a=_js("The maximum number of tags is four.")+" ",this.showStatusMessage(a,$("tagInput")))},
this);this.fireEvent("change",[this.tags])}.bind(this)})).send(this.input.value);this.input.value=""},removeTag:function(b){this.showControls();this.tags=this.tags.filter(function(a){return a.trim()!=b});this.container.getChildren().each(function(a){a.retrieve("tag")==b&&(a.retrieve("saved")?(a.set("html",b),a.setStyle("text-decoration","line-through")):a.destroy())}.bind(this));this.checkMax();this.fireEvent("change",[this.tags])},setup:function(b,a){var c=b.get("text");b.store("tag",c);b.store("saved",
a);b.addEvent("click:relay(.js-tag-delete)",function(a,b){a.stop();var c=b.getParent().get("data-tag").trim();this.removeTag(c);b.getParent().destroy()}.bind(this));when($("removeTag"),function(a){a.getFirst().clone().addEvent("click",function(a){a.stop();this.removeTag(c)}.bind(this)).inject(b)}.bind(this));when($("synonymizeTag"),function(a){a.getFirst().clone().addEvent("click",function(a){a.stop();this.synonymizeTag(c)}.bind(this)).inject(b)}.bind(this));Icons.addEvents(b);this.tags.combine([c]);
this.checkMax()},synonymizeTag:function(b){var a=prompt("CREATING NEW AUTOMATIC TAG SYNONYM\n\nBe careful with this.\n\nAlways replace tag '"+b+"' with:");a&&(new Request.AjaxIO("addSynonym",{onSuccess:function(c){c&&(this.removeTag(b),this.addTag(a))}.bind(this)})).send(this.docid,this.doctype,b,a)},checkMax:function(){if(this.tags.length<this.options.max)return $("tagInput").show(),$("tagsEditStatusMessage").hide(),!1;this.options.hideOnMax&&$("tagInput").hide();return!0},showStatusMessage:function(b,
a){$("tagsEditStatusMessage").setProperty("text",b).inject(a,"after").show()},showControls:function(){this.options.controls&&this.control.show()}};Object.append(TagEditor,Utils.EventsFunctions);Object.append(TagEditor,new Options)});
SingleFieldEditor=new Class({Extends:BlurbFinder,iconShowDisplayType:"inline",initialize:function(b,a,c){var d=b.getElement("a"),e=new Element("span",{"class":"edit iconLink",title:c.field_title||_js("Edit"),styles:{display:"none"},html:'<i class="fa fa-pencil " ></i>'}),g=new Element("span",{"class":"iconLink js-icon-cancel icon-cancel",styles:{display:"none"},html:'<i class="fa fa-times " ></i>'}),f=b.getDimensions().x+20;b.adopt(e);b.adopt(g);var h=new Element("input",{styles:{width:c.width||f}}),
m=function(){h.hide();d.show();e.show(this.iconShowDisplayType);g.hide();this.hideChoices();this.fireEvent("editEnd")}.bind(this);this.addEvent("submit",function(a){(new Request.AjaxIO("setSingleField",{onSuccess:function(a){a&&(b.set("data-single-field",a.field),d.set("text",a.text));m()}})).send(c.field,h.value,a)});h.addEvents({keydown:function(a){"esc"==a.key&&(a.stop(),m())}.bind(this),keypress:function(a){"enter"==a.key&&(a.stop(),this.fireEvent("submit"))}.bind(this)}).hide().inject(d,"after");
e.addEvent("click",function(a){a.stop();d.hide();e.hide();g.show(this.iconShowDisplayType);h.set("value",b.get("data-single-field")).show("inline-block").focus();h.selectRange(0,h.value.length);this.fireEvent("editBegin")}.bind(this));g.addEvent("click",function(a){a.stop();m()});c.hideUntilHover?(h.isVisible()||e.setStyle("visibility","hidden").show(this.iconShowDisplayType),b.addEvents({mouseenter:function(a){h.isVisible()||e.setStyle("visibility","visible")}.bind(this),mouseleave:function(a){h.isVisible()||
e.setStyle("visibility","hidden")}.bind(this)})):e.show(this.iconShowDisplayType);a&&this.parent(h,a,c)}});
App.deviceName&&FrameModules.add("LeadGenerationBannerFrameModule",function(){(new Request.API_2_0("internal/lead_generation",{onSuccess:function(b){b&&b.hasOwnProperty("html")&&($("leadGenerationBanner").innerHTML=b.html,trackEvent("Lead Generation","Banner Shown",App.deviceName),"Directory"===b.BusinessName?trackLink($("proHireButton"),"Lead Generation","Banner Click","Directory"):trackLink($("proHireButton"),"Lead Generation","Banner Click",b.businessName))}})).send({data:{deviceName:App.deviceName}})});
FrameModules.add("GuideWorkLogSettingsFrameModule",function(){new GuideWorkLogSettings});
GuideWorkLogSettings=new Class({ajaxSpinner:new Element("img",{src:"https://d1ulmmr4d4i8j4.cloudfront.net/static/images/sales/ajax_load.gif"}),initialize:function(){this.form=document.id("sidebarGuideWorkLogSettings");this.guideid=this.form.getProperty("data-guideid");this.workLogToggle=new Button.Toggle("workLogToggle",{callback:this.toggle.bind(this)})},buildAjaxSpinner:function(b){return(new Element("span",{"class":"ajax-spinner "+b})).adopt(this.ajaxSpinner)},toggle:function(b){var a=this;b="enabled"==
b.target.get("data-value");var c=$$("[name=intro[revisionid]]").pick(),d=null===c?App.guide_revisionid:c.get("value");$("workLogSettingsField").adopt(a.buildAjaxSpinner("workLogEnable"));(new Request.AjaxIO("setWorkLogEnabled",{onSuccess:function(b){$$(".ajax-spinner").dispose();b.error?(b=Utils.createAlert("error",b.error),$("guideWorkLogSettingsErrors").grab(b,"top"),a.workLogToggle.untoggle()):(null!==c&&c.set("value",b.revisionid),App.guide_revisionid=b.revisionid,App.guideApi&&(App.guideApi.revisionid=
App.guide_revisionid),$$(".form-builder").toggle(b.workLogEnabled))}})).send(a.guideid,d,b)}});
FrameModules.add("CommentsWatchFrameModule",function(){var b=$("commentsWatchOn"),a=$("commentsWatchOff");when(b,function(b){b.getFirst(".js-toggle-watch").addEvent("click",function(d){d.stop();(new Request.AjaxIO("watch",{onSuccess:function(){b.hide();a.show("inline")}})).send("on",this.get("data-context"),this.get("data-contextid"))})});when(a,function(a){a.getFirst(".js-toggle-watch").addEvent("click",function(d){d.stop();(new Request.AjaxIO("watch",{onSuccess:function(){a.hide();b.show("inline")}})).send("off",
this.get("data-context"),this.get("data-contextid"))})})});FrameModules.add("StepListEditFrameModule",function(){new StepIndex});
StepIndex=new Class({initialize:function(){this.sides=[];this.modified=this.editing=!1;this.container=document.id("guideStepIndex");this.savingMsg=document.id("savingReorder");this.errorMsg=document.id("reorderError");var b=this.gatherSteps();this.addHoverEvents(b);$("guideStepIndex").hasClass("locked")||(this.setOriginalStepIndexes(b),this.toggleLink=document.getElement("#toggleStepReorder a"),this.toggleLink.addEvent("click",this.beginEditMode.bind(this)),this.saveControl=document.id("saveReorder"),
this.saveControl.getElement("a[href$=save]").addEvent("click",this.save.bind(this)),this.saveControl.getElement("a[href$=cancel]").addEvent("click",this.cancel.bind(this)));Utils.UnsavedChanges.addHandler(function(){if(this.modified)return _js("You have unsaved changes. Your changes will be lost if you continue.")}.bind(this))},addHoverEvents:function(b){b.each(function(a){a.addEvents({mouseenter:this.setActive.pass([a,!0],this),mouseleave:this.setActive.pass([a,!1],this)});this.setActive(a,!1)},
this);when($E(".guideSidebarAddStep"),function(a){a.addEvents({mouseenter:a.setStyle.pass(["background-position","left -126px"],a),mouseleave:a.setStyle.pass(["background-position","left -84px"],a)})})},addDragEvents:function(){var b=this.gatherSteps();if(!(1>b.length)){this.stepStyle=b[0].getStyles("width","height");var a=0==this.sides.length;b.each(function(b,d){if(a){var e=(new Element("div.left")).setStyles({display:"none",position:"absolute",top:0,left:0,width:"50%",height:"100%"});e.inject(b);
this.sides.push(e);e=(new Element("div.right")).setStyles({display:"none",position:"absolute",top:0,right:0,width:"50%",height:"100%"});e.inject(b);this.sides.push(e)}b.getElement("a").addEvents({mousedown:this.onMousedown.bind(this,b),click:function(a){a.stop()}})},this)}},removeDragEvents:function(){this.gatherSteps().each(function(b){b=b.getElement("a");b.removeEvents("mousedown");b.removeEvents("click")})},setActive:function(b,a){if(!this.editing){var c=b.getElement("a"),d,e;b.hasClass("current")?
c.setStyles({opacity:.01,backgroundColor:"transparent"}):(a?(d=.01,e="addClass"):(d=.3,e="removeClass"),c.setStyles({opacity:d,backgroundColor:"#3c5d8b"}),b[e]("active"))}},onMousedown:function(b,a){a.stop();var c=a.page,d=function(a){a.stop();if(1<=Math.abs(a.page.x-c.x)||1<=Math.abs(a.page.y-c.y))document.removeEvent("mousemove",d),document.removeEvent("mouseup",e),this.startDrag(a,b)}.bind(this),e=function(a){document.removeEvent("mousemove",d);document.removeEvent("mouseup",e)}.bind(this);document.addEvent("mousemove",
d);document.addEvent("mouseup",e)},startDrag:function(b,a){var c=a.getCoordinates(),d=$$("body")[0],c=(new Element("div.ghostStep")).setStyles(Object.append(this.stepStyle,{position:"absolute",top:c.top,left:c.left,border:"1px dashed black",zIndex:1E3}));d.adopt(c);c.store("step",a);a.setStyle("opacity",0);this.sides.invoke("show");c.makeDraggable({droppables:this.sides,container:$("guideStepIndex"),onEnter:this.onEnter.bind(this),onDrop:this.onDrop.bind(this),snap:0,preventDefault:!0}).start(b)},
onEnter:function(b,a){var c=a.hasClass("left");b.retrieve("step").inject(a.getParent(),c?"before":"after")},onDrop:function(b,a){var c=b.retrieve("step");c.getPrevious(".guideSidebarThumb");b.dispose();c.setStyle("opacity",1);this.sides.invoke("hide");this.modified=!0},beginEditMode:function(b){b.stop();this.showError(!1);this.addDragEvents();this.saveControl.replaces(this.toggleLink).show();this.container.addClass("reorderingSteps");this.editing=!0;this.modified=!1},endEditMode:function(){this.removeDragEvents();
this.container.removeClass("reorderingSteps");this.modified=this.editing=!1},hideError:function(){showError()},showError:function(b){b?(this.errorMsg.set("text",b),this.errorMsg.show(),this.errorMsg.dissolve.delay(5E3,this.errorMsg)):this.errorMsg.hide()},save:function(b){b.stop();Auth.required({onAuthorize:this.requestSave.bind(this)})},requestSave:function(b){var a=this.gatherSteps();b=a.map(function(a){return a.get("data-stepid").toInt()});this.savingMsg.replaces(this.saveControl).show();var c=
this.getStepReorderPath(App.guideid,App.guide_revisionid);(new Request.API_2_0(c,{method:"PUT",onSuccess:function(b){App.guide_revisionid=b.revisionid;this.finishSave(a)}.bind(this),onFailure:function(a,b){this.showError(b);this.toggleLink.replaces(this.savingMsg);this.endEditMode()}.bind(this)})).send({stepids:b})},getStepReorderPath:function(b,a){return"guides/"+b+"/steporder?revisionid="+a},finishSave:function(b){b.each(function(a,b){a.getElement(".stepNumber").set("text",b+1)});this.setOriginalStepIndexes(b);
var a=$("guideStepIndex"),c=a.getElement(".current");if(c){var d=c.getPrevious(".guideSidebarThumb"),e=c.getNext(".guideSidebarThumb");when($E(".orderby"),function(a){var b=c.retrieve("originalIndex");a.set("text",b)}.bind(this));when($$(".prevLink"),function(a){a.each(function(a){var b=a.getElement(".prevLinkText");d?(a.set("href",d.getElement("a").get("href")),b.set("html",_js("Previous"))):(b.set("text",_js("Optional details")),a.set("href",$E(".activeNav a").get("href").replace("edit","meta")))},
this)}.bind(this))}when($$(".nextLink"),function(b){b.each(function(b){e?(b.set("href",e.getElement("a").get("href")),b.show()):c?b.hide():b.get("text").substring(0,10)==_js("First step")&&b.set("href",a.getElement("a").get("href"))},this)}.bind(this));this.toggleLink.replaces(this.savingMsg);this.endEditMode()},cancel:function(b){b.stop();b=this.gatherSteps();b.sort(function(a,b){return a.retrieve("originalIndex")-b.retrieve("originalIndex")});var a=$("thumbsContainer");b.each(function(b){b.inject(a,
"bottom")});this.toggleLink.replaces(this.saveControl);this.endEditMode()},gatherSteps:function(){return document.getElements(".guideSidebarThumb")},inOrder:function(b){for(var a=0;a<b.length;a++)if(b[a].retrieve("originalIndex")!=a+1)return!1;return!0},setOriginalStepIndexes:function(b){b.each(function(a,b){a.store("originalIndex",b+1)})}});
FrameModules.add("PatrolThresholdFrameModule",function(){when($("patrolThreshold"),function(b){var a=$E("#patrolThreshold button"),c=b.getElement("input.value"),d=b.type.value,e=b.max_allowed.value.toInt();b.max_displayed.value.toInt();var g=b.infinite.value.toInt(),g="\u221e"===c.value?g:c.value.toInt(),f=new RangeSlider($("patrolSlider"),{type:"single",range:[0,e],position:[g],onChange:function(a){c.value=a===e?"\u221e":a}.bind(this),onComplete:function(b){a.disabled=!1}.bind(this)});c.addEvent("focus",
function(){a.disabled=!1});b.addEvent("submit",function(b){b.stop();b=this.docid.value;var g="\u221e"===c.value?"inf":c.value;(new Request.AjaxIO("saveThreshold",{onSuccess:function(b){this.submitButton.blur();c.blur();"inf"==b||b>=e?(f.set(e),c.value="\u221e"):(f.set(b),c.value=b);a.disabled=!0}.bind(this)})).send(d,b,g)});a.disabled=!0})});FrameModules.add("TopicHierarchyFrameModule",function(){TopicHierarchy.initialize()});
TopicHierarchy={initialize:function(){when($("topicParentForm"),function(b){var a=$("th_wikiid").get("value").toInt(),c=$("th_parentTitle"),d=b.getElement("p"),e=new Autocompleter.Request.JSON(c,"/Guide/JSON/areas",{fxOptions:null,postVar:"search"}),g=function(b){e.hideChoices(!0);b.stop();(new Request.AjaxIO("saveWikiArea",{onSuccess:function(a){d.set("html",a.message);a.error?(c.blur(),d.show().setStyle("opacity",1),function(){(new Fx.Tween(d)).start("opacity",0).chain(d.hide.bind(d))}.delay(1500)):
window.location.reload()}})).send(a,c.get("value"))};b.addEvent("submit",g);b.getElement("a").addEvent("click",g)})}};editorMapping=window.editorMapping||{};function LegacyCommentHandle(b){this.elem=b}
LegacyCommentHandle.prototype={get value(){return this.elem.value},get text(){return this.elem.value},get el(){return this.elem},get editable(){return this.elem},clear:function(){this.elem.value=""},focus:function(){this.editable.activate()},reset:function(){},saveState:function(){},disableEnter:function(){},enableEnter:function(){}};function setupLegacyEditHandle(b,a){var c=a.parentNode.parentNode.id,d=new LegacyCommentHandle(a);b[c]=d;a.dataset.editorId=c;return d}
Array.prototype.forEach.call(document.getElementsByClassName("commentEdit"),setupLegacyEditHandle.bind(null,editorMapping));window.setupLegacyEditHandle=setupLegacyEditHandle;window.editorMapping=editorMapping;
CharCounter={activate:function(b){var a=b.getParent("form").getElements(".maxCharacters"),c=null;if(1===a.length)c=a[0];else{for(var d=0;d<a.length;++d)a[d].getProperty("data-textarea-id")===b.id&&(c=a[d]);if(null===c)throw"Could not find count element for "+b.id;}c.hide();b.addEvent("keyup",this.onKeyup(c,function(){return b.get("value")}));b.addEvents({focus:function(){b.fireEvent("keyup");c.show()},blur:function(){c.hide()}})},activateOnEditor:function(b){var a=b.el.getParent("form").getElement(".maxCharacters");
a.hide();b.editable.addEvents({keyup:this.onKeyup(a,function(){return b.text}),focus:function(){b.editable.fireEvent("keyup");a.show()},blur:function(){a.hide()}})},onKeyup:function(b,a){var c=this.charCounts(b),d=c[0],e=c[1];return function(c){c=a();c=c.replace(/\r\n?/,"\n");c=c.length;var f=e-c;f==e?(b.set("text",f),b.hide()):(c<d?(b.set("text",d-c+" too short"),c=0>c-d?"addClass":"removeClass"):(0>f?b.set("text",Math.abs(f)+" too long"):b.set("text",f),c=0>f?"addClass":"removeClass"),b[c]("maxCharLength"),
b.show())}},charCounts:function(b){var a=parseInt(b.getProperty("data-minimum"),10);b=parseInt(b.get("text"),10);return[a,b]}};window.addEvent("domready",function(){$$(".countCharacters").each(CharCounter.activate.bind(CharCounter))});App.multipleCommentForms||FrameModules.add("CommentsFrameModule",function(){var b=$$(".js-comment-container")[0];b&&new CommentManager(b)});
function CommentManager(b){function a(a){var b=function(b){StatusPanel.deactivate();v.set("html",b.html);ModeratorVote.setupLinkActions();a&&a(v)};StatusPanel.loading(_js("Loading comments..."),20);(new Request.AjaxIO(t(),{onSuccess:b})).send(A,B,!1)}function c(a){a.stop();a=this;var b=_js("View Active"),c="deleted",d=!0;"active"!=a.get("data-mode")&&(b=_js("View Deleted"),c="active",d=!1);(new Request.AjaxIO(t(),{onSuccess:function(a){v.set("html",a.html);ModeratorVote.setupLinkActions()}})).send(u.get("data-context"),
u.get("data-contextid"),d);a.set("html",b);a.set("data-mode",c)}function d(){C=!0;var a=u.retrieve("FormManager:formManager");a.submit()}function e(){formManager=new FormManager(u);w=u.getElement(".maxCharacters");D=parseInt(w.get("text"),10);E=parseInt(w.getProperty("data-minimum"),10);formManager.addSubmitHandler(function(){if(C){var a=z.text.trim().replace(/\r\n?/,"\n").replace(/ +/," "),b=!1;0>=a.length?b=_js("You cannot submit an empty comment!"):a.length>D?b="Your comment is too long. Please keep it under "+
D+" characters. It is currently "+a.length+" characters.":a.length<E&&(b="Your comment is too short. Please write something over "+E+" characters. It is currently "+a.length+" characters.");C=!1;return b?(formManager.showError(z.el,b),!1):!0}});formManager.addSubmitHandler(p);b.addEvent("click:relay(.js-comment-submit)",function(){C=!0});b.id&&$$(".addComment[data-containerid="+b.id+"])").addEvent("click",r);b.addEvent("click:relay(.addComment)",r);b.getElements(".js-toggle-deleted").addEvent("click",
c);Utils.UnsavedChanges.addHandler(function(){if(""!==z.value.trim())return _js("Your comments have not yet been posted. Your changes will be lost if you continue.")})}function g(a){if(y){var b=parseInt(y.get("data-numcomments"),10);a=b+a;b=1===a?_js("One Comment"):_js("%1 Comments").replace("%1",a);y.set("data-numcomments",a);y.set("text",b)}}function f(a){var b=a.get("data-context")||u.get("data-context"),c=a.get("data-contextid")||u.get("data-contextid"),d=a.get("title");null!==b&&null!==c&&null!==
d&&(a.get("text").toLowerCase(),A=b,B=c,L=a.get("data-parentid"),x&&x.set("text",d),u.removeClass("hidden"),formManager.clear(z.el),(new Fx.SmoothScroll({duration:200},window)).toElement(u,"y").chain(function(){z.el.focus()}))}function h(a){var c=this;a.stop();Auth.required({message:_js("Log in to edit a comment"),onAuthorize:function(){var a=c.getParent(".comment"),d=a.getFirst(".commentContent"),f=a.getFirst(".commentEditDiv"),e=c.get("data-commentid"),g=b.getElements(".commentActions");g.addClass("hidden");
var h=editorMapping[a.id];h||(window.prosemirrorComments?(a=f.getFirst(".prosemirror"),h=window.prosemirrorComments.createEditHandle(window.editorMapping,a)):(a=f.getFirst(".commentEdit"),h=window.setupLegacyEditHandle(window.editorMapping,a)));d.hide();f.show();var l=new Request.API_2_0("comments/"+e,{method:"PATCH",onSuccess:function(a){f.hide();d.set("html",a.text_rendered);d.show();h.saveState();g.removeClass("hidden")},onFailure:function(a,b){StatusPanel.deactivate();formManager.error(h.el,b);
h.el.addEvent("blur",function(a){formManager.clearIfError(a.target)});formManager.showStatusMessage(h.el);h.focus()}});f.getFirst(".js-cancel-edit").addEvent("click",function(a){d.show();f.hide();formManager.clearIfError(h.el);h.reset();g.removeClass("hidden")});f.getFirst(".js-submit-edit").addEvent("click",function(a){a.stop();a=h.value.trim();l.send({text:a})})}})}function m(a){a=a.get("data-commentid");a=b.getElement("#comment-"+a);var c=a.getParent(".comment-reply"),d=c?c:a.getParent(".comment-thread"),
f=d.get("data-stepNum"),f=f?f.toInt():0,f=0===f?b.getElements(".noteTitleDiv")[0]:b.getElements('.noteTitleDiv:contains("Step '+f+'")'),e=1;d.destroy();null===c&&(a=a.getSiblings(".comment-reply"),e+=a.length,f&&(a=parseInt(f.get("data-numcomments"),10),f.setProperty("data-numcomments",--a),0===a&&f.destroy()));return e}function n(a){var c=this;a.stop();Auth.required({message:_js("Log in to delete a comment"),onAuthorize:function(){var a=c.get("data-commentid"),d=b.getElement("#comment-"+a);d&&(d=
confirm(_js("Are you sure you want to delete this comment?")))&&(new Request.API_2_0("comments/"+a,{method:"DELETE",onSuccess:function(){var a=m(c);g(-a)}})).send()}})}function l(a){var b=this;a.stop();Auth.required({message:_js("Log in to restore a comment"),onAuthorize:function(){(new Request.AjaxIO("restoreComment",{onSuccess:function(){var a=m(b);g(a)}})).send(b.get("data-commentid"))}})}function q(a,b){StatusPanel.deactivate();formManager.showError(z.el,b)}function p(b,c){B=B||u.get("data-contextid");
A=A||u.get("data-context");Auth.required({message:_js("Log in to add a new comment"),onAuthorize:function(){StatusPanel.loading(_js("Adding note..."),20);(new Request.API_2_0("comments/"+A+"/"+B,{method:"POST",onSuccess:function(b){StatusPanel.deactivate();w.hide();w.set("text",D);z.clear();x.set("text",_js("Add Comment"));a(function(a){g(1);a=a.getElementsByClassName("comment");Array.prototype.slice.call(a).forEach(function(a){delete window.editorMapping[a.id]})})},onFailure:q,onComplete:function(){StatusPanel.deactivate()}})).send({text:z.value,
parentid:L,langid:App.langid})}})}function r(a){a.stop();f(this)}function t(){return b.get("data-api")||"getGroupedCommentsHtml"}var v=b.getElement(".js-comments"),u=b.getElement(".js-add-comment-form");u.store("commentManager",this);var x=u.getElement(".js-add-comment-title"),z=editorMapping[u.id]||new LegacyCommentHandle(u.getElement(".js-comment-content")),w=null,D=null,E=null,y=b.getElement(".js-comment-count"),C=!1,A,B,L;u&&e();v.addEvents({"click:relay(.js-edit-comment)":h,"click:relay(.js-delete-comment)":n,
"click:relay(.js-restore-comment)":l});this.submit=d}
FrameModules.add("ModeratorVoteFrameModule",function(){window.ModeratorVote={adminForce:!0,loading:!1};var b,a,c=null,d=function(c){b=c;Modal.doneLoading();var d=new Element("div");d.set("html",c.html);Modal.open({type:"element",element:d});d=$("moderatorVoteTargetSubmit");a={doctype:c.doctype,docid:c.docid,action:c.action,adminForce:ModeratorVote.adminForce};$("moderatorVoteTargetDocid").addEvent("focus",function(a){$("moderatorVoteTargetRadioOther").set("checked",!0)});d.addEvent("click",e)},e=
function(f){f.stop();f=$("moderatorVoteTargetDocid").get("value");var e=$$("#moderatorVoteMenu .moderatorVoteTargetRadio");c=null;e.each(function(a){a.checked&&(c=a.get("value"))});"box"==c&&(c=f);null==c&&(c="");c=c.trim();""==c?Modal.open({type:"message",message:"Please select a target before proceeding.",buttons:{Ok:function(){d(b)}}}):(a.target_docid=c,a.adminForce=ModeratorVote.adminForce,ModeratorVote.voteRequest.send(a))};ModeratorVote.targetRequest=new Request.AjaxIO("getTargetModal",{onSuccess:d});
ModeratorVote.voteRequest=new Request.AjaxIO("doModeratorVote",{onSuccess:function(a){Modal.doneLoading();ModeratorVote.doneLoading();ModeratorVote.hideChoosePostLinks();null!=a.error?Modal.open({type:"message",message:a.error,buttons:{Ok:function(){window.location.reload()}}}):"passed"==a.result?(Modal.currentState?Modal.loading("Reloading page..."):ModeratorVote.showLoadingOnElement(ModeratorVote.lastLoadingElement,"Reloading page..."),null!=a.link?window.location=a.link:window.location.reload()):
Modal.currentState&&Modal.close()}});ModeratorVote.setupLinkActions=function(){$("content").addEvents({"click:relay(.js-vote-flag-link, .voteFlagLink)":function(a,b){a.stop();var c=b.get("data-docid"),d=b.get("data-doctype"),e=b.getParent(".qaPost");ModeratorVote.showLoadingOnElement(e,'_js("Loading menu...")');e={questionid:ModeratorVote.questionid};ModeratorVote.menuRequest.send(d,c,e);ModeratorVote.lastDoctype=d;ModeratorVote.lastDocid=c;ModeratorVote.lastExtraData=e}})};ModeratorVote.menuRequest=
new Request.AjaxIO("getModeratorVotes",{onSuccess:function(a){var b=new Element("div");b.set("html",a.html);a=b.getElement(".adminForce");null!=a&&(a.checked=ModeratorVote.adminForce);var c=$$(".answerToQuestion, .js-post-answer").length;b.getElements(".moderatorVote").each(function(a){if(!a.hasClass("disabledButton")){var b=a.get("data-docid"),d=a.get("data-doctype"),f=a.get("data-action"),e=a.get("data-cancel"),g=a.get("data-target"),h={doctype:d,docid:b,action:f,target_docid:null,questionid:ModeratorVote.questionid,
cancel:e};"posts"==d&&"accept_an_answer_vote"==f&&(h.target_docid=ModeratorVote.questionid);"false"==g||"true"==e||"posts"==d&&"switch_answer_to_comment_vote"==f&&1==c||"accept_an_answer_vote"==f?a.addEvent("click",function(a){a.stop();ModeratorVote.adminForce=h.adminForce=null!=$("adminForce")&&$("adminForce").checked;"posts"!=d||"switch_answer_to_comment_vote"!=f&&"accept_an_answer_vote"!=f||(h.target_docid=ModeratorVote.questionid);"true"==e?Modal.loading(_js("Canceling vote...")):Modal.loading(_js("Casting vote..."));
ModeratorVote.voteRequest.send(h)}):"posts"==d&&"switch_answer_to_comment_vote"==f&&1<c||"comments"==d&&"comment_to_update_vote"==f?a.addEvent("click",function(a){ModeratorVote.adminForce=h.adminForce=null!=$("adminForce")&&$("adminForce").checked;Modal.loading(_js("Loading..."));ModeratorVote.postPickerRequest.send(h)}):a.addEvent("click",function(a){a.stop();ModeratorVote.adminForce=null!=$("adminForce")&&$("adminForce").checked;Modal.loading(_js("Loading..."));ModeratorVote.targetRequest.send(d,
b,f)})}});Modal.doneLoading();ModeratorVote.doneLoading();Modal.open({type:"element",element:b})}});ModeratorVote.hideChoosePostLinks=function(){var a=$$(".qaEditControls"),b=$$(".choosePostLink"),c=$$(".cancelChoosePostLink");a.each(function(a){a.removeClass("hidden")});b.each(function(a){a.addClass("hidden")});c.each(function(a){a.addClass("hidden")})};ModeratorVote.postPickerRequest=new Request.AjaxIO("getTargetButtonInfo",{onSuccess:function(a){Modal.doneLoading();Modal.close();var b=$$(".qaEditControls"),
c=$$(".choosePostLink");$$(".cancelChoosePostLink");b.each(function(a){a.addClass("hidden")});$$(".cancelChoosePostLink").each(function(a){a.addEvent("click",function(a){a.stop();ModeratorVote.hideChoosePostLinks()})});var d;c.each(function(b){var c=b.get("data-postid");d=a.buttonText;ModeratorVote.adminForce||(d+=" - ",d=null!=a.voteCounts[c]?d+a.voteCounts[c]:d+"0",d+=" / "+a.threshold+(" "+_js("Votes")));b.set("text",d);c==a.docid&&"posts"==a.doctype?$("cancelChoosePostLink"+c).removeClass("hidden"):
(b.removeClass("hidden"),b.removeEvents("click"),b.addEvent("click",function(d){d.stop();d={target_docid:c,doctype:a.doctype,docid:a.docid,action:a.action,adminForce:ModeratorVote.adminForce,questionid:ModeratorVote.questionid};var e=b.getParent(".qaPost");ModeratorVote.showLoadingOnElement(e,_js("Casting vote..."));ModeratorVote.voteRequest.send(d)}))})}});ModeratorVote.showLoadingOnElement=function(a,b,c){return null!=a?(ModeratorVote.loading?ModeratorVote.loadingStatus.update(b,c):(ModeratorVote.loadingStatus=
new LoadingStatus(a),ModeratorVote.loadingStatus.loading(b,c)),ModeratorVote.loading=!0,ModeratorVote.lastLoadingElement=a,!0):!1};ModeratorVote.doneLoading=function(){return ModeratorVote.loading?(ModeratorVote.loadingStatus.doneLoading(),ModeratorVote.loading=!1,!0):!1};ModeratorVote.setupLinkActions();var g=$("questionidSpan");ModeratorVote.questionid=null!=g?g.get("text"):!1});FrameModules.add("MessageUserFrameModule",function(){MessageUser.initialize()});
MessageUser={initialize:function(){this.messageModal=$("messageUserModal");this.messageForm=$("messageUserForm");this.messageRecipientUserid=$("messageRecipientUserid");this.messageRecipientName=$("messageRecipientName");this.messageRecipient=$("recipientName");this.messageSubject=$("messageSubject");this.messageBody=$("messageBody");this.messageCancel=$("messageCancel");this.messageUserButtons=$$(".messageUserButton");this.messageUserButtons.length&&(this.formManager=new FormManager(this.messageForm,
{jumpToErrors:!1,fixedPosition:!0}),this.formManager.required("messageSubject","messageBody"),this.formManager.addSubmitHandler(function(){(new Request.AjaxIO("sendMessage",{onSuccess:function(b){StatusPanel.notify(b.message,2,{reload:!1})}})).send(this.messageRecipientUserid.value,this.messageSubject.value,this.messageBody.value);Modal.forceClose();StatusPanel.loading(_js("Sending message..."),100,{reload:!1});return!1}.bind(this)),this.messageUserButtons.each(function(b){b.addEvent("click",function(a){a.stop();
Auth.required({message:_js("You must be logged in to send another user a message"),onAuthorize:function(){var a=b.get("data-recipient-userid"),d=b.get("data-recipient-name"),e=b.get("data-subject"),g=b.get("data-body");this.messageRecipientUserid.set("value",a);this.messageRecipientName.set("value",d);this.messageRecipient.set("text",d);e||(e="");this.messageSubject.set("value",e);g||(g="");this.messageBody.set("value",g);Modal.open({type:"element",element:this.messageModal,locked:!0})}.bind(this)})}.bind(this))}.bind(this)),
this.messageCancel.addEvent("click",function(b){b.stop();Modal.forceClose()}))}};FrameModules.add("GuidePublishFrameModule",function(){when($("sidebarGuidePublish"),function(b){new GuidePublish})});
GuidePublish=new Class({ajaxSpinner:new Element("img",{src:"https://d1ulmmr4d4i8j4.cloudfront.net/static/images/sales/ajax_load.gif"}),initialize:function(){var b=this;this.form=document.id("sidebarGuidePublish");this.guideid=this.form.getProperty("data-guideid");this.guideTeamList=document.id("guideTeamList");this.teamListField=document.id("teamListField");this.guideUserList=document.id("guideUserList");this.userListField=document.id("userListField");this.userSearchInput=document.id("searchUsers");
this.teamSearchInput=document.id("searchTeams");this.userSearchSpinner=document.id("userSearchSpinner");this.teamSearchSpinner=document.id("teamSearchSpinner");this.userListMessage=document.id("userListMessage");App.noAvatarUrl||console.error("App.noAvatarUrl is not set.");this.userFinder=new UserFinder(this.userSearchInput,{indicator:this.userSearchSpinner,showReputation:!this.form.hasClass("noReputation"),onSelection:function(a,c,d){"object"===typeof a&&(a=a.retrieve("user"),(new Request.API_2_0("guides/"+
b.guideid+"/users/"+a.userid,{method:"put",statusPanelMessage:_js("Adding user to guide..."),onSuccess:function(a){b.renderUserList(a.users)}})).send())}});when(this.teamSearchInput,function(a){new TeamFinder(a,{indicator:this.teamSearchSpinner,onSelection:function(a){"object"===typeof a&&(a=a.retrieve("team"),b.addTeam(a.teamid))}})});this.publishToggle=new Button.Toggle("publishToggle",{callback:this.publish.bind(this)});this.teamListField&&$$(".removeTeam").addEvent("click",this.removeTeam.bind(this));
this.userListField&&this.guideUserList.addEvent("click:relay(.removeUser)",function(a,c){a.stop();var d=c.getProperty("data-userid");(new Request.API_2_0("guides/"+b.guideid+"/users/"+d,{method:"delete",statusPanelMessage:_js("Removing user from guide..."),onSuccess:function(a){b.renderUserList(a.users)}})).send()})},renderUserList:function(b){this.guideUserList.empty();b.length?this.userListMessage.removeClass("hidden"):this.userListMessage.addClass("hidden");b.each(function(a){var b=new Element("li");
(new Element("img",{src:a.image&&a.image.mini?a.image.mini:App.noAvatarUrl,"class":"pull-left"})).inject(b);var d=(new Element("div",{"class":"userDetails"})).inject(b),e=(new Element("h4")).inject(d);(new Element("a",{href:a.url,text:a.username})).inject(e);(new Element("p",{text:a.reputation+" "+_js("reputation"),"class":"reputation"})).inject(d);a=(new Element("a",{"data-userid":a.userid,"class":"removeUser"})).inject(d);(new Element("i",{"class":"fa fa-times"})).inject(a);(new Element("div",{"class":"clearer"})).inject(b);
b.inject(this.guideUserList)})},buildAjaxSpinner:function(b){return(new Element("span",{"class":"ajax-spinner "+b})).adopt(this.ajaxSpinner)},publish:function(b){var a=this;b="public"==(b.target.get("data-value")?b.target:b.target.getParent("[data-value]")).get("data-value");var c=$$("[name=intro[revisionid]]").pick(),d=null===c?App.guide_revisionid:c.get("value");$("publishField").adopt(a.buildAjaxSpinner("publish"));(new Request.API_2_0("guides/"+a.guideid+"/public?revisionid="+d,{method:b?"put":
"delete",onFailure:function(b){var c=JSON.decode(b.response);$$(".ajax-spinner").dispose();var d=_js("An unexpected error occurred.");c&&c.message&&(d=c.message);404===b.status?d=_js("Guide not found. Try reloading the page."):409===b.status&&(d=_js("Sorry, someone saved a new version of the introduction while you were editing it, so we couldn't save your changes. Reload the pages to load in the latest changes."));$("guidePublishErrors").grab(Utils.createAlert("error",d),"top");a.publishToggle.untoggle()},
onSuccess:function(b){$$(".ajax-spinner").dispose();null!==c&&c.set("value",b.revisionid);App.guide_revisionid=b.revisionid;App.guideApi&&(App.guideApi.revisionid=App.guide_revisionid);a.teamListField&&(b["public"]?(a.teamListField.hide(),a.userListField.hide()):(a.teamListField.show(),a.userListField.show()))}})).send(a.guideid,b)},removeTeam:function(b){b.stop();b=b.target.getParent("a");var a=b.getParent("li");b=b.getProperty("data-teamid");var c=this;(new Request.AjaxIO("removeGuideTeam",{onSuccess:function(b){$$(".ajax-spinner").hide();
b.success?(b.forceRefresh&&window.location.reload(!0),TweenMax.to(a,.3,{height:0,overflow:"hidden",onComplete:function(){a.dispose();0===c.guideTeamList.getChildren("li").length&&c.toggleDefaultText("noTeams")}})):a.inject(new Element("p",{html:_js("Error deleting team"),"class":"error"}))}})).send(this.guideid,b,App.fromTab)},addTeam:function(b){var a=this;(new Request.AjaxIO("addGuideTeam",{onSuccess:function(b){var d=$("guideTeamList");d.set("html",b.html);d.getElements(".removeTeam").addEvent("click",
a.removeTeam.bind(a));a.toggleDefaultText("yesTeams");$$(".ajax-spinner").hide()}})).send(this.guideid,[b],App.fromTab)},toggleDefaultText:function(b){this.teamListField.getElements(".defaultText").addClass("hidden");this.teamListField.getElements(".defaultText."+b).removeClass("hidden")}});
UserFinder=new Class({Extends:Autocompleter.Request.API_2_0,el:null,initialize:function(b,a){App.noAvatarUrl||console.error("App.noAvatarUrl is not set.");a=Object.merge({className:"blurb-finder",fxOptions:null,maxChoices:5,delay:100,truncateText:!1,overflow:!1,showReputation:!0,injectChoice:this.injectChoice.bind(this)},a);this.el=b;this.parent(this.el,"users/search",a);this.url=this.request.request.options.url;this.choices.addEvent("mousedown",function(a){a.stop()})},query:function(){this.toggleIndicator(!0);
var b=Object.clone(this.options.getData)||{};this.request.request.options.url=this.url+"/"+this.queryValue;this.fireEvent("onRequest",[this.element,this.request,b,this.queryValue]);this.request.send({data:b})},injectChoice:function(b){if(this.el.isDisplayed()){var a={user:b,userImage:b.image&&b.image.mini?b.image.mini:App.noAvatarUrl,showImage:!0,reputationTitle:_js("Reputation"),blurbId:"user-"+b.type+"-"+b.id,showReputation:this.showReputation},a=Template.get('<li class="blurb-item" id="{{blurbId}}">\n   {{#if showImage}}\n      <div class="blurb-image one-one">\n         <img src="{{userImage}}" alt="{{user.username}} Avatar">\n      </div>\n   {{/if}}\n   <div class="blurb-text">\n      <p class="blurb-title">{{user.username}}\n         {{#if showReputation}}<span class="reputation" title="{{reputationTitle}}">({{user.reputation}})</span>{{/if}}\n      </p>\n      <p>Userid: {{user.userid}}</p>\n   </div>\n</li>\n')(a);
a.store("user",b);a.inputValue="";this.addChoiceEvents(a).inject(this.choices)}}});
TeamFinder=new Class({Extends:Autocompleter.Request.API_2_0,el:null,initialize:function(b,a){App.noAvatarUrl||console.error("App.noAvatarUrl is not set.");a=Object.merge({className:"blurb-finder",fxOptions:null,maxChoices:5,delay:100,truncateText:!1,overflow:!1,injectChoice:this.injectChoice.bind(this)},a);this.el=b;this.maxChoices=a.maxChoices;this.parent(this.el,"teams/search",a);this.url=this.request.request.options.url;this.choices.addEvent("mousedown",function(a){a.stop()})},query:function(){this.toggleIndicator(!0);
var b=Object.clone(this.options.getData)||{};this.request.request.options.url=this.url+"/"+this.queryValue+("?limit="+this.maxChoices);this.fireEvent("onRequest",[this.element,this.request,b,this.queryValue]);this.request.send({data:b})},injectChoice:function(b){if(this.el.isDisplayed()){var a={team:b,imageUrl:b.imageUrl||App.noAvatarUrl,showImage:!0},a=Template.get('<li class="blurb-item" id="team-{{team.teamid}}">\n   {{#if showImage}}\n      <div class="blurb-image one-one">\n         <img src="{{imageUrl}}" alt="{{team.name}} Avatar">\n      </div>\n   {{/if}}\n   <div class="blurb-text">\n      <p class="blurb-title">{{team.name}}</p>\n      <p>Teamid: {{team.teamid}}</p>\n   </div>\n</li>\n')(a);
a.store("team",b);a.inputValue="";this.addChoiceEvents(a).inject(this.choices)}}});
Modal.addEvent("onGlossaryLoad",function(){clickSafe($("addWordButton"),function(){var b=$("bottomPortion"),a=$("exitModalButton"),c=$("newPhrase").get("text"),c=c.substring(1,c.length-1);$("newPhrase").set("text",_js("Working..."));$("spinner").set("src","https://d1ulmmr4d4i8j4.cloudfront.net/static/images/modal/spinner.gif");$("addWordButton").toggle();$("topPortion").set("text","");a.toggle();b.toggle();var d=$("glossaryLink");(new Request.AjaxIO("sendWord",{onSuccess:function(e){a.set("text",
_js("Exit"));a.toggle();$("newPhrase").set("text",c);$("spinner").destroy();$("topPortion").set("text",e.result);var g=_js("was not added to ");e.success&&(g=_js("was added to "));b.set("text",g);b.grab(d,"bottom");b.toggle()}})).send(c)});clickSafe($("exitModalButton"),function(){Modal.close()})});
